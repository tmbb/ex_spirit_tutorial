<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="ExDoc v0.18.1">
    <title>First Parsers – ex_spirit_tutorial v0.1.0</title>
    <link rel="stylesheet" href="dist/app-c922dbe7ef.css" />
    
    <script src="dist/sidebar_items-cd92c21b07.js"></script>
    
    <link rel="stylesheet" href="dist/ex_doc_makeup-css.css"/>
    
    
  </head>
  <body data-type="extras">
    <script>try { if(localStorage.getItem('night-mode')) document.body.className += ' night-mode'; } catch (e) { }</script>

<div class="main">
<button class="sidebar-toggle">
  <span class="icon-menu" aria-hidden="true"></span>
  <span class="sr-only">Toggle Sidebar</span>
</button>
<section class="sidebar">

  
  <a href="api-reference.html" class="sidebar-projectLink">
    <div class="sidebar-projectDetails">
      <h1 class="sidebar-projectName">
        ex_spirit_tutorial
      </h1>
      <h2 class="sidebar-projectVersion">
        v0.1.0
      </h2>
    </div>
    
  </a>

  <form class="sidebar-search" action="search.html">
    <button type="submit" class="search-button">
      <span class="icon-search" aria-hidden="true"></span>
    </button>
    <input name="q" type="text" id="search-list" class="search-input" placeholder="search" aria-label="Search" autocomplete="off" />
  </form>

  <ul class="sidebar-listNav">
    <li><a id="extras-list" href="#full-list">Pages</a></li>

    
      <li><a id="modules-list" href="#full-list">Modules</a></li>
    

    

    
  </ul>
  <div class="gradient"></div>
  <ul id="full-list" class="sidebar-fullList"></ul>
</section>

<section class="content">
  <div class="content-outer">
    <div id="content" class="content-inner">


<h1>First Parsers</h1>
<h2 id="introduction-to-the-context" class="section-heading">
  <a href="#introduction-to-the-context" class="hover-link"><span class="icon-link" aria-hidden="true"></span></a>
  Introduction to the Context
</h2>

<p>In the previous chapter you’ve defined a parsing module:</p>
<pre><code class="nohighlight makeup elixir"><span class="kd">defmodule</span><span class="w"> </span><span class="nc">ExSpiritTutorial.Setup.ExampleTextParser</span><span class="w"> </span><span class="k" data-group-id="39">do</span><span class="w">
  </span><span class="kn">use</span><span class="w"> </span><span class="nc">ExSpirit.Parser</span><span class="p">,</span><span class="w"> </span><span class="ss">text</span><span class="p">:</span><span class="w"> </span><span class="no">true</span><span class="w">
  </span><span class="c1"># write the rest of your parsing code here...
</span><span class="k" data-group-id="39">end</span></code></pre>
<p>ExSpirit has injected some functions and macros into that module that you can play with.
Let’s open up an <code class="inline">iex</code> session and import that module.</p>
<pre><code class="nohighlight makeup"><span class="gp">iex&gt;</span><span class="w"> </span><span class="kn">import</span><span class="w"> </span><span class="nc">ExSpiritTutorial.Setup.ExampleTextParser</span><span class="w">
</span><span class="nc">ExSpiritTutorial.Setup.ExampeTextParser</span></code></pre>
<p>Let’s parse a character:</p>
<pre><code class="nohighlight makeup"><span class="gp">iex&gt;</span><span class="w"> </span><span class="n">parse</span><span class="p" data-group-id="16">(</span><span class="s2">&quot;a&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">char</span><span class="p" data-group-id="15">()</span><span class="p" data-group-id="16">)</span><span class="w">
</span><span class="p" data-group-id="235">%</span><span class="nc" data-group-id="235">ExSpirit.Parser.Context</span><span class="p" data-group-id="235">{</span><span class="ss">column</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="ss">error</span><span class="p">:</span><span class="w"> </span><span class="no">nil</span><span class="p">,</span><span class="w"> </span><span class="ss">filename</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;&lt;unknown&gt;&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">line</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
 </span><span class="ss">position</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="ss">rest</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">result</span><span class="p">:</span><span class="w"> </span><span class="mi">97</span><span class="p">,</span><span class="w"> </span><span class="ss">rulestack</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="179">[]</span><span class="p">,</span><span class="w"> </span><span class="ss">skipper</span><span class="p">:</span><span class="w"> </span><span class="no">nil</span><span class="p">,</span><span class="w"> </span><span class="ss">state</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="214">%{}</span><span class="p">,</span><span class="w">
 </span><span class="ss">userdata</span><span class="p">:</span><span class="w"> </span><span class="no">nil</span><span class="p" data-group-id="235">}</span></code></pre>
<p>What is this? We’ve tried to parse a character out of a string, and instead of a sensible result, like a character, or a list of characters or something like that, we get a monster <code class="inline">struct</code> with lots of fields!</p>
<p>Let’s try to decompose the <code class="inline">struct</code> in a way that makes sense:</p>
<pre><code class="nohighlight makeup"><span class="gp">iex&gt;</span><span class="w"> </span><span class="n">context</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">parse</span><span class="p" data-group-id="30">(</span><span class="s2">&quot;a&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">char</span><span class="p" data-group-id="29">()</span><span class="p" data-group-id="30">)</span><span class="w">
</span><span class="p" data-group-id="256">%</span><span class="nc" data-group-id="256">ExSpirit.Parser.Context</span><span class="p" data-group-id="256">{</span><span class="ss">column</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="ss">error</span><span class="p">:</span><span class="w"> </span><span class="no">nil</span><span class="p">,</span><span class="w"> </span><span class="ss">filename</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;&lt;unknown&gt;&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">line</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
 </span><span class="ss">position</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="ss">rest</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">result</span><span class="p">:</span><span class="w"> </span><span class="mi">97</span><span class="p">,</span><span class="w"> </span><span class="ss">rulestack</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="207">[]</span><span class="p">,</span><span class="w"> </span><span class="ss">skipper</span><span class="p">:</span><span class="w"> </span><span class="no">nil</span><span class="p">,</span><span class="w"> </span><span class="ss">state</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="241">%{}</span><span class="p">,</span><span class="w">
 </span><span class="ss">userdata</span><span class="p">:</span><span class="w"> </span><span class="no">nil</span><span class="p" data-group-id="256">}</span><span class="w">
</span><span class="gp">iex&gt;</span><span class="w"> </span><span class="n">context</span><span class="o">.</span><span class="n">result</span><span class="w">
</span><span class="mi">97</span><span class="w">
</span><span class="gp">iex&gt;</span><span class="w"> </span><span class="sc">?a</span><span class="w">
</span><span class="mi">97</span></code></pre>
<p>So, the <code class="inline">struct</code> contains a <code class="inline">result</code>, which is what we expect: we’ve parse the character <code class="inline">?a</code> (remember that Elixir makes no distinction between characters and numbers).
Let’s explore it further. The <code class="inline">filename</code>, <code class="inline">line</code>, <code class="inline">column</code> and <code class="inline">position</code> are pretty obvious:</p>
<pre><code class="nohighlight makeup"><span class="gp">iex&gt;</span><span class="w"> </span><span class="n">context</span><span class="o">.</span><span class="n">filename</span><span class="w">
</span><span class="s2">&quot;&lt;unknown&gt;&quot;</span><span class="w">
</span><span class="gp">iex&gt;</span><span class="w"> </span><span class="p" data-group-id="42">{</span><span class="n">context</span><span class="o">.</span><span class="n">line</span><span class="p">,</span><span class="w"> </span><span class="n">context</span><span class="o">.</span><span class="n">column</span><span class="p" data-group-id="42">}</span><span class="w">
</span><span class="p" data-group-id="79">{</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p" data-group-id="79">}</span><span class="w">
</span><span class="gp">iex&gt;</span><span class="w"> </span><span class="n">context</span><span class="o">.</span><span class="n">position</span><span class="w">
</span><span class="mi">1</span></code></pre>
<p>The represent the position of the parser along the string:</p>
<ul>
<li>The <code class="inline">filename</code> is <code class="inline">&quot;&lt;unknown&gt;&quot;</code>, because we are parsing from a string and not from a file
</li>
<li>The <code class="inline">line</code> and <code class="inline">column</code> fields represent the current line and column, and per the usual convention ExSpirit starts counting line and column numbers at 1 instead of 0
</li>
<li>The <code class="inline">position</code> field represents the position along the sting <em>in bytes</em> (not characters!)
</li>
</ul>
<p>These fields are very useful for error reporting.
Besides that, we can tag the tokens we parse with position information, which can be useful for debugging later.</p>
<pre><code class="nohighlight makeup"><span class="gp">iex&gt;</span><span class="w"> </span><span class="n">context</span><span class="o">.</span><span class="n">error</span><span class="w">
</span><span class="no">nil</span></code></pre>
<p>There is a field called <code class="inline">error</code>, which is currently <code class="inline">nil</code>.
This means that the parser has succeeded.
The absence of error means the presence of success.
We will explore different kinds of errors later.</p>
<p>We will ignore the fields <code class="inline">rulestack</code>, <code class="inline">skipper</code>, <code class="inline">state</code> and <code class="inline">userdata</code> for now.
We will go back to them later, of course, as some of these fields are essential to parse context-sensitive grammars</p>
<p>We still haven’t discussed the <code class="inline">rest</code> field.
The <code class="inline">rest</code> field is merely the bytes we still haven’t consumed.
Let’s see what <code class="inline">iex</code> tells us:</p>
<pre><code class="nohighlight makeup"><span class="gp">iex&gt;</span><span class="w"> </span><span class="n">context</span><span class="o">.</span><span class="n">rest</span><span class="w">
</span><span class="s2">&quot;&quot;</span></code></pre>
<p>This means we’ve consume the whole string and there is nothing left.
This is expected, as we’ve tried to parse a single character out of a string with a single character.</p>
<p>Let’s try another example:</p>
<pre><code class="nohighlight makeup"><span class="gp">iex&gt;</span><span class="w"> </span><span class="p" data-group-id="10">%{</span><span class="ss">result</span><span class="p">:</span><span class="w"> </span><span class="n">result</span><span class="p">,</span><span class="w"> </span><span class="ss">rest</span><span class="p">:</span><span class="w"> </span><span class="n">rest</span><span class="p" data-group-id="10">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">parse</span><span class="p" data-group-id="44">(</span><span class="s2">&quot;ab&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">char</span><span class="p" data-group-id="43">()</span><span class="p" data-group-id="44">)</span><span class="w">
</span><span class="p" data-group-id="270">%</span><span class="nc" data-group-id="270">ExSpirit.Parser.Context</span><span class="p" data-group-id="270">{</span><span class="ss">column</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="ss">error</span><span class="p">:</span><span class="w"> </span><span class="no">nil</span><span class="p">,</span><span class="w"> </span><span class="ss">filename</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;&lt;unknown&gt;&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">line</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
 </span><span class="ss">position</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="ss">rest</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;b&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">result</span><span class="p">:</span><span class="w"> </span><span class="mi">97</span><span class="p">,</span><span class="w"> </span><span class="ss">rulestack</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="217">[]</span><span class="p">,</span><span class="w"> </span><span class="ss">skipper</span><span class="p">:</span><span class="w"> </span><span class="no">nil</span><span class="p">,</span><span class="w"> </span><span class="ss">state</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="254">%{}</span><span class="p">,</span><span class="w">
 </span><span class="ss">userdata</span><span class="p">:</span><span class="w"> </span><span class="no">nil</span><span class="p" data-group-id="270">}</span><span class="w">
</span><span class="gp">iex&gt;</span><span class="w"> </span><span class="p" data-group-id="279">{</span><span class="n">result</span><span class="p">,</span><span class="w"> </span><span class="n">rest</span><span class="p" data-group-id="279">}</span><span class="w">
</span><span class="p" data-group-id="291">{</span><span class="mi">97</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;b&quot;</span><span class="p" data-group-id="291">}</span><span class="w">
</span><span class="gp">iex&gt;</span><span class="w"> </span><span class="sc">?a</span><span class="w">
</span><span class="mi">97</span></code></pre>
<p>Now we’ve tried to parse a single character out of a string with two characters.
We can see that the <code class="inline">result</code> is the same as above, but now the <code class="inline">rest</code> is different.
There is still a binary with one byte left (i.e. <code class="inline">&quot;b&quot;</code>).</p>
<p>This “monster <code class="inline">struct</code>” is the Context.
While consuming bytes from the stream, ExSpirit will thread the Context along, updating it as bytes are consumed.</p>
<p>The primitive parsers abstract away the context, so that you only see it in the final result value.
In the intermediate steps it looks as if you’re just defining declarative grammar rules that operate on a simple string.
This allows for simpler parser definitions for PEG parsers.</p>
<p>On the other hand, the real power of ExSpirit lies in the ability to have the context available at any moment, so that you can:</p>
<ul>
<li>annotate tokens with context data (like position information)
</li>
<li>pass constant parameters to a rule deep into the grammar
</li>
<li>or even feed data from the context to the next parser so that it can use that information on what to do next.
</li>
</ul>
<p>This allows you to create context-dependent combinators, which you can use to parse context-sensitive languages.</p>
<h3 id="unicode-and-other-encodings" class="section-heading">
  <a href="#unicode-and-other-encodings" class="hover-link"><span class="icon-link" aria-hidden="true"></span></a>
  Unicode and Other Encodings
</h3>

<p>If you’re paying attention, you’ve probably noticed how we’ve talked about characters and bytes in different contexts.
If you’re interested in parsing files encoded with UTF-8 that may contain characters outside the ASCII range, this is an important distinction.
ExSpirit uses UTF-8 underneath for all character-related functionality, which means it handles Unicode just fine.
For example, let’s try to parse a character out of this string:</p>
<pre><code class="nohighlight makeup"><span class="gp">iex&gt;</span><span class="w"> </span><span class="p" data-group-id="17">%{</span><span class="ss">result</span><span class="p">:</span><span class="w"> </span><span class="n">result</span><span class="p">,</span><span class="w"> </span><span class="ss">rest</span><span class="p">:</span><span class="w"> </span><span class="n">rest</span><span class="p">,</span><span class="w"> </span><span class="ss">position</span><span class="p">:</span><span class="w"> </span><span class="n">position</span><span class="p" data-group-id="17">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">parse</span><span class="p" data-group-id="69">(</span><span class="s2">&quot;Átomo&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">char</span><span class="p" data-group-id="68">()</span><span class="p" data-group-id="69">)</span><span class="w">
</span><span class="p" data-group-id="275">%</span><span class="nc" data-group-id="275">ExSpirit.Parser.Context</span><span class="p" data-group-id="275">{</span><span class="ss">column</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="ss">error</span><span class="p">:</span><span class="w"> </span><span class="no">nil</span><span class="p">,</span><span class="w"> </span><span class="ss">filename</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;&lt;unknown&gt;&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">line</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
 </span><span class="ss">position</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="ss">rest</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;tomo&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">result</span><span class="p">:</span><span class="w"> </span><span class="mi">193</span><span class="p">,</span><span class="w"> </span><span class="ss">rulestack</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="236">[]</span><span class="p">,</span><span class="w"> </span><span class="ss">skipper</span><span class="p">:</span><span class="w"> </span><span class="no">nil</span><span class="p">,</span><span class="w">
 </span><span class="ss">state</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="268">%{}</span><span class="p">,</span><span class="w"> </span><span class="ss">userdata</span><span class="p">:</span><span class="w"> </span><span class="no">nil</span><span class="p" data-group-id="275">}</span><span class="w">
</span><span class="gp">iex&gt;</span><span class="w"> </span><span class="p" data-group-id="288">{</span><span class="n">result</span><span class="p">,</span><span class="w"> </span><span class="n">rest</span><span class="p">,</span><span class="w"> </span><span class="n">position</span><span class="p" data-group-id="288">}</span><span class="w">
</span><span class="p" data-group-id="297">{</span><span class="mi">193</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;tomo&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p" data-group-id="297">}</span><span class="w">
</span><span class="gp">iex&gt;</span><span class="w"> </span><span class="sc">?Á</span><span class="w">
</span><span class="mi">193</span><span class="w">
</span><span class="gp">iex&gt;</span><span class="w"> </span><span class="n">byte_size</span><span class="p" data-group-id="309">(</span><span class="s2">&quot;Á&quot;</span><span class="p" data-group-id="309">)</span><span class="w">
</span><span class="mi">2</span></code></pre>
<p>You can see that ExSpirit has correctly parsed the single character <code class="inline">?Á</code>, even though it’s not an ASCII character.
Although a single character was parsed, two bytes were consumed, and that’s why <code class="inline">position</code> is two.</p>
<p>Although ExSpirit handles UTF-8 by default, this doesn’t mean that ExSpirit is restricted to parsing UTF-8.
You can write your own primitive parsers that accept a certain encoding and use ExSpirit’s combinator parsers on top of those primiive parsers.</p>
<h2 id="from-a-peg-grammar-to-an-exspirit-grammar" class="section-heading">
  <a href="#from-a-peg-grammar-to-an-exspirit-grammar" class="hover-link"><span class="icon-link" aria-hidden="true"></span></a>
  From a PEG Grammar to an ExSpirit Grammar
</h2>

<p>A PEG grammar supports the following operations:</p>
<ul>
<li>Sequence: <code class="inline">e1 e2</code> - parser <code class="inline">e1</code> after parser <code class="inline">e2</code>
</li>
<li>Ordered choice: <code class="inline">e1 / e2</code> - parser <code class="inline">e1</code> or parser <code class="inline">e2</code>, the fist that matches
</li>
<li>Zero-or-more: <code class="inline">e*</code> - parser <code class="inline">e</code>, repeated zero or more times
</li>
<li>One-or-more: <code class="inline">e+</code> - parser <code class="inline">e</code>, repeated one or more times
</li>
<li>Optional: <code class="inline">e?</code> - parser <code class="inline">e</code> or nothing
</li>
<li>And-predicate: <code class="inline">&amp;e</code>, also called positive lookahead: test if parser <code class="inline">e</code> matches the rest of the input, but doesn’t consume input itself. Succeeds if it matches the input.
</li>
<li>Not-predicate: <code class="inline">!e</code>, also called negative lookahead: test if parser <code class="inline">e</code> matches the rest of the input, and succeeds it it fails to match.
</li>
</ul>
<p>Now let’s see how we can emulate a PEG grammar with ExSpirit.
Let’s define a parser module with some parsers:</p>
<pre><code class="nohighlight makeup elixir"><span class="kd">defmodule</span><span class="w"> </span><span class="nc">ExSpiritTutorial.PegParsers.PegOperations</span><span class="w"> </span><span class="k" data-group-id="117">do</span><span class="w">
  </span><span class="kn">use</span><span class="w"> </span><span class="nc">ExSpirit.Parser</span><span class="p">,</span><span class="w"> </span><span class="ss">text</span><span class="p">:</span><span class="w"> </span><span class="no">true</span><span class="w">

  </span><span class="kd">defrule</span><span class="w"> </span><span class="nf">e1</span><span class="p" data-group-id="50">(</span><span class="w">
    </span><span class="n">char</span><span class="p" data-group-id="49">(</span><span class="sc">?x</span><span class="p" data-group-id="49">)</span><span class="p" data-group-id="50">)</span><span class="w">

  </span><span class="kd">defrule</span><span class="w"> </span><span class="nf">e2</span><span class="p" data-group-id="85">(</span><span class="w">
    </span><span class="n">char</span><span class="p" data-group-id="84">(</span><span class="sc">?y</span><span class="p" data-group-id="84">)</span><span class="p" data-group-id="85">)</span><span class="w">

  </span><span class="kd">defrule</span><span class="w"> </span><span class="nf">e</span><span class="p" data-group-id="114">(</span><span class="w">
    </span><span class="n">char</span><span class="p" data-group-id="113">(</span><span class="sc">?a</span><span class="p" data-group-id="113">)</span><span class="p" data-group-id="114">)</span><span class="w">
</span><span class="k" data-group-id="117">end</span></code></pre>
<p>Now, fire up <code class="inline">iex</code> and import the module to play with it a little:</p>
<pre><code class="nohighlight makeup"><span class="gp">iex&gt;</span><span class="w"> </span><span class="kn">import</span><span class="w"> </span><span class="nc">ExSpiritTutorial.PegParsers.PegOperations</span><span class="w">
</span><span class="nc">ExSpiritTutorial.PegParsers.PegOperations</span></code></pre>
<h3 id="sequence-seq" class="section-heading">
  <a href="#sequence-seq" class="hover-link"><span class="icon-link" aria-hidden="true"></span></a>
  Sequence - <code class="inline">seq</code>
</h3>

<p>In a PEG grammar, sequence is denoted by juxtaposition of parsers: <code class="inline">e1 e2</code>.
Instead of using this syntax, ExSpirit defines the <a href="https://hexdocs.pm/ex_spirit/ExSpirit.Parser.html#seq/2" title=""><code class="inline">ExSpirit.Parser.seq/2</code></a> combinator:</p>
<pre><code class="nohighlight makeup"><span class="gp">iex&gt;</span><span class="w"> </span><span class="p" data-group-id="6">%{</span><span class="ss">error</span><span class="p">:</span><span class="w"> </span><span class="no">nil</span><span class="p" data-group-id="6">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">parse</span><span class="p" data-group-id="60">(</span><span class="s2">&quot;xy&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">seq</span><span class="p" data-group-id="59">(</span><span class="p" data-group-id="58">[</span><span class="n">e1</span><span class="p">,</span><span class="w"> </span><span class="n">e2</span><span class="p" data-group-id="58">]</span><span class="p" data-group-id="59">)</span><span class="p" data-group-id="60">)</span><span class="w">
</span><span class="p" data-group-id="273">%</span><span class="nc" data-group-id="273">ExSpirit.Parser.Context</span><span class="p" data-group-id="273">{</span><span class="ss">column</span><span class="p">:</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="ss">error</span><span class="p">:</span><span class="w"> </span><span class="no">nil</span><span class="p">,</span><span class="w"> </span><span class="ss">filename</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;&lt;unknown&gt;&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">line</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
 </span><span class="ss">position</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="ss">rest</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">result</span><span class="p">:</span><span class="w"> </span><span class="s1">'xy'</span><span class="p">,</span><span class="w"> </span><span class="ss">rulestack</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="221">[]</span><span class="p">,</span><span class="w"> </span><span class="ss">skipper</span><span class="p">:</span><span class="w"> </span><span class="no">nil</span><span class="p">,</span><span class="w"> </span><span class="ss">state</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="263">%{}</span><span class="p">,</span><span class="w">
 </span><span class="ss">userdata</span><span class="p">:</span><span class="w"> </span><span class="no">nil</span><span class="p" data-group-id="273">}</span></code></pre>
<p>If you try to parse an invalid sequence, it will fail with an error.</p>
<pre><code class="nohighlight makeup"><span class="gp">iex&gt;</span><span class="w"> </span><span class="p" data-group-id="7">%{</span><span class="ss">error</span><span class="p">:</span><span class="w"> </span><span class="n">error</span><span class="p" data-group-id="7">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">parse</span><span class="p" data-group-id="67">(</span><span class="s2">&quot;xa&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">seq</span><span class="p" data-group-id="66">(</span><span class="p" data-group-id="65">[</span><span class="n">e1</span><span class="p">,</span><span class="w"> </span><span class="n">e2</span><span class="p" data-group-id="65">]</span><span class="p" data-group-id="66">)</span><span class="p" data-group-id="67">)</span><span class="w">
</span><span class="p" data-group-id="351">%</span><span class="nc" data-group-id="351">ExSpirit.Parser.Context</span><span class="p" data-group-id="351">{</span><span class="ss">column</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w">
 </span><span class="ss">error</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="306">%</span><span class="nc" data-group-id="306">ExSpirit.Parser.ParseException</span><span class="p" data-group-id="306">{</span><span class="ss">context</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="292">%</span><span class="nc" data-group-id="292">ExSpirit.Parser.Context</span><span class="p" data-group-id="292">{</span><span class="ss">column</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w">
   </span><span class="ss">error</span><span class="p">:</span><span class="w"> </span><span class="no">nil</span><span class="p">,</span><span class="w"> </span><span class="ss">filename</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;&lt;unknown&gt;&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">line</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="ss">position</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="ss">rest</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;a&quot;</span><span class="p">,</span><span class="w">
   </span><span class="ss">result</span><span class="p">:</span><span class="w"> </span><span class="mi">120</span><span class="p">,</span><span class="w"> </span><span class="ss">rulestack</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="274">[</span><span class="ss">:e2</span><span class="p" data-group-id="274">]</span><span class="p">,</span><span class="w"> </span><span class="ss">skipper</span><span class="p">:</span><span class="w"> </span><span class="no">nil</span><span class="p">,</span><span class="w"> </span><span class="ss">state</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="283">%{}</span><span class="p">,</span><span class="w"> </span><span class="ss">userdata</span><span class="p">:</span><span class="w"> </span><span class="no">nil</span><span class="p" data-group-id="292">}</span><span class="p">,</span><span class="w">
  </span><span class="ss">extradata</span><span class="p">:</span><span class="w"> </span><span class="no">nil</span><span class="p">,</span><span class="w">
  </span><span class="ss">message</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Tried parsing out any of the the characters of `'y'` but failed due to the input character not matching&quot;</span><span class="p" data-group-id="306">}</span><span class="p">,</span><span class="w">
 </span><span class="ss">filename</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;&lt;unknown&gt;&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">line</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="ss">position</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="ss">rest</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;a&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">result</span><span class="p">:</span><span class="w"> </span><span class="mi">120</span><span class="p">,</span><span class="w">
 </span><span class="ss">rulestack</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="330">[]</span><span class="p">,</span><span class="w"> </span><span class="ss">skipper</span><span class="p">:</span><span class="w"> </span><span class="no">nil</span><span class="p">,</span><span class="w"> </span><span class="ss">state</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="341">%{}</span><span class="p">,</span><span class="w"> </span><span class="ss">userdata</span><span class="p">:</span><span class="w"> </span><span class="no">nil</span><span class="p" data-group-id="351">}</span></code></pre>
<p>In fact, the error is quite descriptive:</p>
<pre><code class="nohighlight makeup"><span class="gp">iex&gt;</span><span class="w"> </span><span class="n">error</span><span class="w">
</span><span class="p" data-group-id="262">%</span><span class="nc" data-group-id="262">ExSpirit.Parser.ParseException</span><span class="p" data-group-id="262">{</span><span class="ss">context</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="206">%</span><span class="nc" data-group-id="206">ExSpirit.Parser.Context</span><span class="p" data-group-id="206">{</span><span class="ss">column</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w">
  </span><span class="ss">error</span><span class="p">:</span><span class="w"> </span><span class="no">nil</span><span class="p">,</span><span class="w"> </span><span class="ss">filename</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;&lt;unknown&gt;&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">line</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="ss">position</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="ss">rest</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;a&quot;</span><span class="p">,</span><span class="w">
  </span><span class="ss">result</span><span class="p">:</span><span class="w"> </span><span class="mi">120</span><span class="p">,</span><span class="w"> </span><span class="ss">rulestack</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="156">[</span><span class="ss">:e2</span><span class="p" data-group-id="156">]</span><span class="p">,</span><span class="w"> </span><span class="ss">skipper</span><span class="p">:</span><span class="w"> </span><span class="no">nil</span><span class="p">,</span><span class="w"> </span><span class="ss">state</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="189">%{}</span><span class="p">,</span><span class="w"> </span><span class="ss">userdata</span><span class="p">:</span><span class="w"> </span><span class="no">nil</span><span class="p" data-group-id="206">}</span><span class="p">,</span><span class="w">
 </span><span class="ss">extradata</span><span class="p">:</span><span class="w"> </span><span class="no">nil</span><span class="p">,</span><span class="w">
 </span><span class="ss">message</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Tried parsing out any of the the characters of `'y'` but failed due to the input character not matching&quot;</span><span class="p" data-group-id="262">}</span></code></pre>
<p>It tells you dat at that context (<code class="inline">position: 1</code>, that is, after consuming a single byte), it was expecting to find one of the characters in <code class="inline">[?y]</code>.</p>
<p>You can see that <code class="inline">seq([e1, e2])</code> is equivalent to <code class="inline">e1 e2</code> in PEG notation.</p>
<h3 id="ordered-choice-alt" class="section-heading">
  <a href="#ordered-choice-alt" class="hover-link"><span class="icon-link" aria-hidden="true"></span></a>
  Ordered Choice - <code class="inline">alt</code>
</h3>

<p>In a PEG grammar, sequence is denoted by the <code class="inline">/</code> operator: <code class="inline">e1 / e2</code>.
Instead of using this syntax, ExSpirit defines the <a href="https://hexdocs.pm/ex_spirit/ExSpirit.Parser.html#alt/2" title=""><code class="inline">ExSpirit.Parser.alt/2</code></a> combinator:</p>
<pre><code class="nohighlight makeup"><span class="gp">iex&gt;</span><span class="w"> </span><span class="p" data-group-id="5">%{</span><span class="ss">error</span><span class="p">:</span><span class="w"> </span><span class="no">nil</span><span class="p" data-group-id="5">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">parse</span><span class="p" data-group-id="64">(</span><span class="s2">&quot;x&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">alt</span><span class="p" data-group-id="63">(</span><span class="p" data-group-id="62">[</span><span class="n">e1</span><span class="p">,</span><span class="w"> </span><span class="n">e2</span><span class="p" data-group-id="62">]</span><span class="p" data-group-id="63">)</span><span class="p" data-group-id="64">)</span><span class="w">
</span><span class="p" data-group-id="272">%</span><span class="nc" data-group-id="272">ExSpirit.Parser.Context</span><span class="p" data-group-id="272">{</span><span class="ss">column</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="ss">error</span><span class="p">:</span><span class="w"> </span><span class="no">nil</span><span class="p">,</span><span class="w"> </span><span class="ss">filename</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;&lt;unknown&gt;&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">line</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
 </span><span class="ss">position</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="ss">rest</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">result</span><span class="p">:</span><span class="w"> </span><span class="mi">120</span><span class="p">,</span><span class="w"> </span><span class="ss">rulestack</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="231">[]</span><span class="p">,</span><span class="w"> </span><span class="ss">skipper</span><span class="p">:</span><span class="w"> </span><span class="no">nil</span><span class="p">,</span><span class="w"> </span><span class="ss">state</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="264">%{}</span><span class="p">,</span><span class="w">
 </span><span class="ss">userdata</span><span class="p">:</span><span class="w"> </span><span class="no">nil</span><span class="p" data-group-id="272">}</span><span class="w">

</span><span class="gp">iex&gt;</span><span class="w"> </span><span class="p" data-group-id="280">%{</span><span class="ss">error</span><span class="p">:</span><span class="w"> </span><span class="no">nil</span><span class="p" data-group-id="280">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">parse</span><span class="p" data-group-id="296">(</span><span class="s2">&quot;y&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">alt</span><span class="p" data-group-id="295">(</span><span class="p" data-group-id="294">[</span><span class="n">e1</span><span class="p">,</span><span class="w"> </span><span class="n">e2</span><span class="p" data-group-id="294">]</span><span class="p" data-group-id="295">)</span><span class="p" data-group-id="296">)</span><span class="w">
</span><span class="p" data-group-id="357">%</span><span class="nc" data-group-id="357">ExSpirit.Parser.Context</span><span class="p" data-group-id="357">{</span><span class="ss">column</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="ss">error</span><span class="p">:</span><span class="w"> </span><span class="no">nil</span><span class="p">,</span><span class="w"> </span><span class="ss">filename</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;&lt;unknown&gt;&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">line</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
 </span><span class="ss">position</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="ss">rest</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">result</span><span class="p">:</span><span class="w"> </span><span class="mi">121</span><span class="p">,</span><span class="w"> </span><span class="ss">rulestack</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="333">[]</span><span class="p">,</span><span class="w"> </span><span class="ss">skipper</span><span class="p">:</span><span class="w"> </span><span class="no">nil</span><span class="p">,</span><span class="w"> </span><span class="ss">state</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="349">%{}</span><span class="p">,</span><span class="w">
 </span><span class="ss">userdata</span><span class="p">:</span><span class="w"> </span><span class="no">nil</span><span class="p" data-group-id="357">}</span></code></pre>
<p>It will fail when given an invalid character, of course:</p>
<pre><code class="nohighlight makeup"><span class="gp">iex&gt;</span><span class="w"> </span><span class="p" data-group-id="4">%{</span><span class="ss">error</span><span class="p">:</span><span class="w"> </span><span class="n">error</span><span class="p" data-group-id="4">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">parse</span><span class="p" data-group-id="47">(</span><span class="s2">&quot;b&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">alt</span><span class="p" data-group-id="46">(</span><span class="p" data-group-id="45">[</span><span class="n">e1</span><span class="p">,</span><span class="w"> </span><span class="n">e2</span><span class="p" data-group-id="45">]</span><span class="p" data-group-id="46">)</span><span class="p" data-group-id="47">)</span><span class="w">
</span><span class="p" data-group-id="343">%</span><span class="nc" data-group-id="343">ExSpirit.Parser.Context</span><span class="p" data-group-id="343">{</span><span class="ss">column</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
 </span><span class="ss">error</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="302">%</span><span class="nc" data-group-id="302">ExSpirit.Parser.ParseException</span><span class="p" data-group-id="302">{</span><span class="ss">context</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="286">%</span><span class="nc" data-group-id="286">ExSpirit.Parser.Context</span><span class="p" data-group-id="286">{</span><span class="ss">column</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
   </span><span class="ss">error</span><span class="p">:</span><span class="w"> </span><span class="no">nil</span><span class="p">,</span><span class="w"> </span><span class="ss">filename</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;&lt;unknown&gt;&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">line</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="ss">position</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="ss">rest</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;b&quot;</span><span class="p">,</span><span class="w">
   </span><span class="ss">result</span><span class="p">:</span><span class="w"> </span><span class="no">nil</span><span class="p">,</span><span class="w"> </span><span class="ss">rulestack</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="267">[</span><span class="ss">:e2</span><span class="p" data-group-id="267">]</span><span class="p">,</span><span class="w"> </span><span class="ss">skipper</span><span class="p">:</span><span class="w"> </span><span class="no">nil</span><span class="p">,</span><span class="w"> </span><span class="ss">state</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="281">%{}</span><span class="p">,</span><span class="w"> </span><span class="ss">userdata</span><span class="p">:</span><span class="w"> </span><span class="no">nil</span><span class="p" data-group-id="286">}</span><span class="p">,</span><span class="w">
  </span><span class="ss">extradata</span><span class="p">:</span><span class="w"> </span><span class="no">nil</span><span class="p">,</span><span class="w">
  </span><span class="ss">message</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Tried parsing out any of the the characters of `'y'` but failed due to the input character not matching&quot;</span><span class="p" data-group-id="302">}</span><span class="p">,</span><span class="w">
 </span><span class="ss">filename</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;&lt;unknown&gt;&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">line</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="ss">position</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="ss">rest</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;b&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">result</span><span class="p">:</span><span class="w"> </span><span class="no">nil</span><span class="p">,</span><span class="w">
 </span><span class="ss">rulestack</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="321">[]</span><span class="p">,</span><span class="w"> </span><span class="ss">skipper</span><span class="p">:</span><span class="w"> </span><span class="no">nil</span><span class="p">,</span><span class="w"> </span><span class="ss">state</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="335">%{}</span><span class="p">,</span><span class="w"> </span><span class="ss">userdata</span><span class="p">:</span><span class="w"> </span><span class="no">nil</span><span class="p" data-group-id="343">}</span><span class="w">

</span><span class="gp">iex&gt;</span><span class="w"> </span><span class="n">error</span><span class="w">
</span><span class="p" data-group-id="404">%</span><span class="nc" data-group-id="404">ExSpirit.Parser.ParseException</span><span class="p" data-group-id="404">{</span><span class="ss">context</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="390">%</span><span class="nc" data-group-id="390">ExSpirit.Parser.Context</span><span class="p" data-group-id="390">{</span><span class="ss">column</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
  </span><span class="ss">error</span><span class="p">:</span><span class="w"> </span><span class="no">nil</span><span class="p">,</span><span class="w"> </span><span class="ss">filename</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;&lt;unknown&gt;&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">line</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="ss">position</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="ss">rest</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;b&quot;</span><span class="p">,</span><span class="w">
  </span><span class="ss">result</span><span class="p">:</span><span class="w"> </span><span class="no">nil</span><span class="p">,</span><span class="w"> </span><span class="ss">rulestack</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="383">[</span><span class="ss">:e2</span><span class="p" data-group-id="383">]</span><span class="p">,</span><span class="w"> </span><span class="ss">skipper</span><span class="p">:</span><span class="w"> </span><span class="no">nil</span><span class="p">,</span><span class="w"> </span><span class="ss">state</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="385">%{}</span><span class="p">,</span><span class="w"> </span><span class="ss">userdata</span><span class="p">:</span><span class="w"> </span><span class="no">nil</span><span class="p" data-group-id="390">}</span><span class="p">,</span><span class="w">
 </span><span class="ss">extradata</span><span class="p">:</span><span class="w"> </span><span class="no">nil</span><span class="p">,</span><span class="w">
 </span><span class="ss">message</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Tried parsing out any of the the characters of `'y'` but failed due to the input character not matching&quot;</span><span class="p" data-group-id="404">}</span><span class="w">
</span><span class="gp">iex(13)&gt;</span></code></pre>
<p>Look at the error message above.
It’s telling us that the parser failed to parse the <code class="inline">?y</code> character. Why?
Remember that PEG parsers try to match the alternatives in order.
When the first alternative  (<code class="inline">?x</code>) fails, there is no problem, as there are still other alternatives to test.
But when the second alternative  (<code class="inline">?y</code>) fails, there are no more alternatives, and the parser fails with the error.</p>
<p>You can see that <code class="inline">alt([e1, e2])</code> is equivalent to <code class="inline">e1 / e2</code> in PEG notation.</p>
<h3 id="zero-or-more-repeat-2" class="section-heading">
  <a href="#zero-or-more-repeat-2" class="hover-link"><span class="icon-link" aria-hidden="true"></span></a>
  Zero Or More - <code class="inline">repeat/2</code>
</h3>

<p>In a PEG grammar, sequence is denoted by the <code class="inline">*</code> postfix operator: <code class="inline">e*</code>.
Instead of using this syntax, ExSpirit defines the <a href="https://hexdocs.pm/ex_spirit/ExSpirit.Parser.html#repeat/2" title=""><code class="inline">ExSpirit.Parser.repeat/2</code></a> combinator:</p>
<pre><code class="nohighlight makeup"><span class="gp">iex&gt;</span><span class="w"> </span><span class="p" data-group-id="3">%{</span><span class="ss">error</span><span class="p">:</span><span class="w"> </span><span class="no">nil</span><span class="p" data-group-id="3">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">parse</span><span class="p" data-group-id="33">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">repeat</span><span class="p" data-group-id="32">(</span><span class="n">e</span><span class="p" data-group-id="32">)</span><span class="p" data-group-id="33">)</span><span class="w">
</span><span class="p" data-group-id="255">%</span><span class="nc" data-group-id="255">ExSpirit.Parser.Context</span><span class="p" data-group-id="255">{</span><span class="ss">column</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="ss">error</span><span class="p">:</span><span class="w"> </span><span class="no">nil</span><span class="p">,</span><span class="w"> </span><span class="ss">filename</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;&lt;unknown&gt;&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">line</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
 </span><span class="ss">position</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="ss">rest</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">result</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="184">[]</span><span class="p">,</span><span class="w"> </span><span class="ss">rulestack</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="204">[]</span><span class="p">,</span><span class="w"> </span><span class="ss">skipper</span><span class="p">:</span><span class="w"> </span><span class="no">nil</span><span class="p">,</span><span class="w"> </span><span class="ss">state</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="240">%{}</span><span class="p">,</span><span class="w">
 </span><span class="ss">userdata</span><span class="p">:</span><span class="w"> </span><span class="no">nil</span><span class="p" data-group-id="255">}</span><span class="w">

</span><span class="gp">iex&gt;</span><span class="w"> </span><span class="p" data-group-id="269">%{</span><span class="ss">error</span><span class="p">:</span><span class="w"> </span><span class="no">nil</span><span class="p" data-group-id="269">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">parse</span><span class="p" data-group-id="290">(</span><span class="s2">&quot;a&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">repeat</span><span class="p" data-group-id="289">(</span><span class="n">e</span><span class="p" data-group-id="289">)</span><span class="p" data-group-id="290">)</span><span class="w">
</span><span class="p" data-group-id="336">%</span><span class="nc" data-group-id="336">ExSpirit.Parser.Context</span><span class="p" data-group-id="336">{</span><span class="ss">column</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="ss">error</span><span class="p">:</span><span class="w"> </span><span class="no">nil</span><span class="p">,</span><span class="w"> </span><span class="ss">filename</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;&lt;unknown&gt;&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">line</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
 </span><span class="ss">position</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="ss">rest</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">result</span><span class="p">:</span><span class="w"> </span><span class="s1">'a'</span><span class="p">,</span><span class="w"> </span><span class="ss">rulestack</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="320">[]</span><span class="p">,</span><span class="w"> </span><span class="ss">skipper</span><span class="p">:</span><span class="w"> </span><span class="no">nil</span><span class="p">,</span><span class="w"> </span><span class="ss">state</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="332">%{}</span><span class="p">,</span><span class="w">
 </span><span class="ss">userdata</span><span class="p">:</span><span class="w"> </span><span class="no">nil</span><span class="p" data-group-id="336">}</span><span class="w">

</span><span class="gp">iex&gt;</span><span class="w"> </span><span class="p" data-group-id="344">%{</span><span class="ss">error</span><span class="p">:</span><span class="w"> </span><span class="no">nil</span><span class="p" data-group-id="344">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">parse</span><span class="p" data-group-id="362">(</span><span class="s2">&quot;aa&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">repeat</span><span class="p" data-group-id="361">(</span><span class="n">e</span><span class="p" data-group-id="361">)</span><span class="p" data-group-id="362">)</span><span class="w">
</span><span class="p" data-group-id="401">%</span><span class="nc" data-group-id="401">ExSpirit.Parser.Context</span><span class="p" data-group-id="401">{</span><span class="ss">column</span><span class="p">:</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="ss">error</span><span class="p">:</span><span class="w"> </span><span class="no">nil</span><span class="p">,</span><span class="w"> </span><span class="ss">filename</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;&lt;unknown&gt;&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">line</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
 </span><span class="ss">position</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="ss">rest</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">result</span><span class="p">:</span><span class="w"> </span><span class="s1">'aa'</span><span class="p">,</span><span class="w"> </span><span class="ss">rulestack</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="387">[]</span><span class="p">,</span><span class="w"> </span><span class="ss">skipper</span><span class="p">:</span><span class="w"> </span><span class="no">nil</span><span class="p">,</span><span class="w"> </span><span class="ss">state</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="397">%{}</span><span class="p">,</span><span class="w">
 </span><span class="ss">userdata</span><span class="p">:</span><span class="w"> </span><span class="no">nil</span><span class="p" data-group-id="401">}</span><span class="w">

</span><span class="gp">iex&gt;</span><span class="w"> </span><span class="p" data-group-id="403">%{</span><span class="ss">error</span><span class="p">:</span><span class="w"> </span><span class="no">nil</span><span class="p" data-group-id="403">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">parse</span><span class="p" data-group-id="413">(</span><span class="s2">&quot;aaaa&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">repeat</span><span class="p" data-group-id="412">(</span><span class="n">e</span><span class="p" data-group-id="412">)</span><span class="p" data-group-id="413">)</span><span class="w">
</span><span class="p" data-group-id="453">%</span><span class="nc" data-group-id="453">ExSpirit.Parser.Context</span><span class="p" data-group-id="453">{</span><span class="ss">column</span><span class="p">:</span><span class="w"> </span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="ss">error</span><span class="p">:</span><span class="w"> </span><span class="no">nil</span><span class="p">,</span><span class="w"> </span><span class="ss">filename</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;&lt;unknown&gt;&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">line</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
 </span><span class="ss">position</span><span class="p">:</span><span class="w"> </span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="ss">rest</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">result</span><span class="p">:</span><span class="w"> </span><span class="s1">'aaaa'</span><span class="p">,</span><span class="w"> </span><span class="ss">rulestack</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="441">[]</span><span class="p">,</span><span class="w"> </span><span class="ss">skipper</span><span class="p">:</span><span class="w"> </span><span class="no">nil</span><span class="p">,</span><span class="w"> </span><span class="ss">state</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="448">%{}</span><span class="p">,</span><span class="w">
 </span><span class="ss">userdata</span><span class="p">:</span><span class="w"> </span><span class="no">nil</span><span class="p" data-group-id="453">}</span></code></pre>
<p>The <code class="inline">repeat</code> combinator will apply the parser given as argument as many times as possible and gather the results into a list.
As you can see, the result is always a list of the <code class="inline">?a</code> character, repeated on or more times.</p>
<h3 id="one-or-more-repeat-3-again" class="section-heading">
  <a href="#one-or-more-repeat-3-again" class="hover-link"><span class="icon-link" aria-hidden="true"></span></a>
  One Or More - <code class="inline">repeat/3</code> again
</h3>

<p>There is no specific combinator to match one or more repetitions of a given parser, but
you can pass a minimal number of repetitions to the <code class="inline">repeat</code> combinator.
If you pass a minimum of 1 repetition, you can emulate the “One Or More” operation.</p>
<pre><code class="nohighlight makeup"><span class="gp">iex&gt;</span><span class="w"> </span><span class="p" data-group-id="8">%{</span><span class="ss">error</span><span class="p">:</span><span class="w"> </span><span class="n">error</span><span class="p" data-group-id="8">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">parse</span><span class="p" data-group-id="54">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">repeat</span><span class="p" data-group-id="53">(</span><span class="n">e</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p" data-group-id="53">)</span><span class="p" data-group-id="54">)</span><span class="w">
</span><span class="p" data-group-id="342">%</span><span class="nc" data-group-id="342">ExSpirit.Parser.Context</span><span class="p" data-group-id="342">{</span><span class="ss">column</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
 </span><span class="ss">error</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="303">%</span><span class="nc" data-group-id="303">ExSpirit.Parser.ParseException</span><span class="p" data-group-id="303">{</span><span class="ss">context</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="284">%</span><span class="nc" data-group-id="284">ExSpirit.Parser.Context</span><span class="p" data-group-id="284">{</span><span class="ss">column</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
   </span><span class="ss">error</span><span class="p">:</span><span class="w"> </span><span class="no">nil</span><span class="p">,</span><span class="w"> </span><span class="ss">filename</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;&lt;unknown&gt;&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">line</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="ss">position</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="ss">rest</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="p">,</span><span class="w">
   </span><span class="ss">result</span><span class="p">:</span><span class="w"> </span><span class="no">nil</span><span class="p">,</span><span class="w"> </span><span class="ss">rulestack</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="265">[]</span><span class="p">,</span><span class="w"> </span><span class="ss">skipper</span><span class="p">:</span><span class="w"> </span><span class="no">nil</span><span class="p">,</span><span class="w"> </span><span class="ss">state</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="282">%{}</span><span class="p">,</span><span class="w"> </span><span class="ss">userdata</span><span class="p">:</span><span class="w"> </span><span class="no">nil</span><span class="p" data-group-id="284">}</span><span class="p">,</span><span class="w">
  </span><span class="ss">extradata</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w">
  </span><span class="ss">message</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Repeating over a parser failed due to not reaching the minimum amount of 1 with only a repeat count of 0&quot;</span><span class="p" data-group-id="303">}</span><span class="p">,</span><span class="w">
 </span><span class="ss">filename</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;&lt;unknown&gt;&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">line</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="ss">position</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="ss">rest</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">result</span><span class="p">:</span><span class="w"> </span><span class="no">nil</span><span class="p">,</span><span class="w">
 </span><span class="ss">rulestack</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="328">[]</span><span class="p">,</span><span class="w"> </span><span class="ss">skipper</span><span class="p">:</span><span class="w"> </span><span class="no">nil</span><span class="p">,</span><span class="w"> </span><span class="ss">state</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="334">%{}</span><span class="p">,</span><span class="w"> </span><span class="ss">userdata</span><span class="p">:</span><span class="w"> </span><span class="no">nil</span><span class="p" data-group-id="342">}</span><span class="w">

</span><span class="gp">iex(23)&gt;</span><span class="w"> </span><span class="p" data-group-id="350">%{</span><span class="ss">error</span><span class="p">:</span><span class="w"> </span><span class="no">nil</span><span class="p" data-group-id="350">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">parse</span><span class="p" data-group-id="366">(</span><span class="s2">&quot;a&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">repeat</span><span class="p" data-group-id="365">(</span><span class="n">e</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p" data-group-id="365">)</span><span class="p" data-group-id="366">)</span><span class="w">
</span><span class="p" data-group-id="405">%</span><span class="nc" data-group-id="405">ExSpirit.Parser.Context</span><span class="p" data-group-id="405">{</span><span class="ss">column</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="ss">error</span><span class="p">:</span><span class="w"> </span><span class="no">nil</span><span class="p">,</span><span class="w"> </span><span class="ss">filename</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;&lt;unknown&gt;&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">line</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
 </span><span class="ss">position</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="ss">rest</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">result</span><span class="p">:</span><span class="w"> </span><span class="s1">'a'</span><span class="p">,</span><span class="w"> </span><span class="ss">rulestack</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="396">[]</span><span class="p">,</span><span class="w"> </span><span class="ss">skipper</span><span class="p">:</span><span class="w"> </span><span class="no">nil</span><span class="p">,</span><span class="w"> </span><span class="ss">state</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="402">%{}</span><span class="p">,</span><span class="w">
 </span><span class="ss">userdata</span><span class="p">:</span><span class="w"> </span><span class="no">nil</span><span class="p" data-group-id="405">}</span><span class="w">

</span><span class="gp">iex&gt;</span><span class="w"> </span><span class="p" data-group-id="409">%{</span><span class="ss">error</span><span class="p">:</span><span class="w"> </span><span class="no">nil</span><span class="p" data-group-id="409">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">parse</span><span class="p" data-group-id="423">(</span><span class="s2">&quot;aa&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">repeat</span><span class="p" data-group-id="422">(</span><span class="n">e</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p" data-group-id="422">)</span><span class="p" data-group-id="423">)</span><span class="w">
</span><span class="p" data-group-id="463">%</span><span class="nc" data-group-id="463">ExSpirit.Parser.Context</span><span class="p" data-group-id="463">{</span><span class="ss">column</span><span class="p">:</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="ss">error</span><span class="p">:</span><span class="w"> </span><span class="no">nil</span><span class="p">,</span><span class="w"> </span><span class="ss">filename</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;&lt;unknown&gt;&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">line</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
 </span><span class="ss">position</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="ss">rest</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">result</span><span class="p">:</span><span class="w"> </span><span class="s1">'aa'</span><span class="p">,</span><span class="w"> </span><span class="ss">rulestack</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="452">[]</span><span class="p">,</span><span class="w"> </span><span class="ss">skipper</span><span class="p">:</span><span class="w"> </span><span class="no">nil</span><span class="p">,</span><span class="w"> </span><span class="ss">state</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="461">%{}</span><span class="p">,</span><span class="w">
 </span><span class="ss">userdata</span><span class="p">:</span><span class="w"> </span><span class="no">nil</span><span class="p" data-group-id="463">}</span><span class="w">

</span><span class="gp">iex&gt;</span><span class="w"> </span><span class="p" data-group-id="465">%{</span><span class="ss">error</span><span class="p">:</span><span class="w"> </span><span class="no">nil</span><span class="p" data-group-id="465">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">parse</span><span class="p" data-group-id="476">(</span><span class="s2">&quot;aaaa&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">repeat</span><span class="p" data-group-id="475">(</span><span class="n">e</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p" data-group-id="475">)</span><span class="p" data-group-id="476">)</span><span class="w">
</span><span class="p" data-group-id="502">%</span><span class="nc" data-group-id="502">ExSpirit.Parser.Context</span><span class="p" data-group-id="502">{</span><span class="ss">column</span><span class="p">:</span><span class="w"> </span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="ss">error</span><span class="p">:</span><span class="w"> </span><span class="no">nil</span><span class="p">,</span><span class="w"> </span><span class="ss">filename</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;&lt;unknown&gt;&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">line</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
 </span><span class="ss">position</span><span class="p">:</span><span class="w"> </span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="ss">rest</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">result</span><span class="p">:</span><span class="w"> </span><span class="s1">'aaaa'</span><span class="p">,</span><span class="w"> </span><span class="ss">rulestack</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="497">[]</span><span class="p">,</span><span class="w"> </span><span class="ss">skipper</span><span class="p">:</span><span class="w"> </span><span class="no">nil</span><span class="p">,</span><span class="w"> </span><span class="ss">state</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="500">%{}</span><span class="p">,</span><span class="w">
 </span><span class="ss">userdata</span><span class="p">:</span><span class="w"> </span><span class="no">nil</span><span class="p" data-group-id="502">}</span></code></pre>
<h3 id="optional" class="section-heading">
  <a href="#optional" class="hover-link"><span class="icon-link" aria-hidden="true"></span></a>
  Optional
</h3>

<p>TODO: What’s the best equivalent to optional?</p>
<h3 id="and-predicate-lookahead" class="section-heading">
  <a href="#and-predicate-lookahead" class="hover-link"><span class="icon-link" aria-hidden="true"></span></a>
  And-Predicate - <code class="inline">lookahead</code>
</h3>

<pre><code class="nohighlight makeup"><span class="gp">iex&gt;</span><span class="w"> </span><span class="p" data-group-id="21">%{</span><span class="ss">error</span><span class="p">:</span><span class="w"> </span><span class="no">nil</span><span class="p">,</span><span class="w"> </span><span class="ss">result</span><span class="p">:</span><span class="w"> </span><span class="n">result</span><span class="p">,</span><span class="w"> </span><span class="ss">rest</span><span class="p">:</span><span class="w"> </span><span class="n">rest</span><span class="p" data-group-id="21">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">parse</span><span class="p" data-group-id="77">(</span><span class="s2">&quot;a&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">lookahead</span><span class="p" data-group-id="76">(</span><span class="n">e</span><span class="p" data-group-id="76">)</span><span class="p" data-group-id="77">)</span><span class="w">
</span><span class="p" data-group-id="278">%</span><span class="nc" data-group-id="278">ExSpirit.Parser.Context</span><span class="p" data-group-id="278">{</span><span class="ss">column</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="ss">error</span><span class="p">:</span><span class="w"> </span><span class="no">nil</span><span class="p">,</span><span class="w"> </span><span class="ss">filename</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;&lt;unknown&gt;&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">line</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
 </span><span class="ss">position</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="ss">rest</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;a&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">result</span><span class="p">:</span><span class="w"> </span><span class="no">nil</span><span class="p">,</span><span class="w"> </span><span class="ss">rulestack</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="242">[]</span><span class="p">,</span><span class="w"> </span><span class="ss">skipper</span><span class="p">:</span><span class="w"> </span><span class="no">nil</span><span class="p">,</span><span class="w"> </span><span class="ss">state</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="271">%{}</span><span class="p">,</span><span class="w">
 </span><span class="ss">userdata</span><span class="p">:</span><span class="w"> </span><span class="no">nil</span><span class="p" data-group-id="278">}</span><span class="w">

</span><span class="gp">iex&gt;</span><span class="w"> </span><span class="p" data-group-id="285">{</span><span class="n">result</span><span class="p">,</span><span class="w"> </span><span class="n">rest</span><span class="p" data-group-id="285">}</span><span class="w">
</span><span class="p" data-group-id="293">{</span><span class="no">nil</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;a&quot;</span><span class="p" data-group-id="293">}</span><span class="w">

</span><span class="gp">iex&gt;</span><span class="w"> </span><span class="n">parse</span><span class="p" data-group-id="308">(</span><span class="s2">&quot;x&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">lookahead</span><span class="p" data-group-id="307">(</span><span class="n">e</span><span class="p" data-group-id="307">)</span><span class="p" data-group-id="308">)</span><span class="w">
</span><span class="p" data-group-id="492">%</span><span class="nc" data-group-id="492">ExSpirit.Parser.Context</span><span class="p" data-group-id="492">{</span><span class="ss">column</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
 </span><span class="ss">error</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="466">%</span><span class="nc" data-group-id="466">ExSpirit.Parser.ParseException</span><span class="p" data-group-id="466">{</span><span class="ss">context</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="369">%</span><span class="nc" data-group-id="369">ExSpirit.Parser.Context</span><span class="p" data-group-id="369">{</span><span class="ss">column</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
   </span><span class="ss">error</span><span class="p">:</span><span class="w"> </span><span class="no">nil</span><span class="p">,</span><span class="w"> </span><span class="ss">filename</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;&lt;unknown&gt;&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">line</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="ss">position</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="ss">rest</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;x&quot;</span><span class="p">,</span><span class="w">
   </span><span class="ss">result</span><span class="p">:</span><span class="w"> </span><span class="no">nil</span><span class="p">,</span><span class="w"> </span><span class="ss">rulestack</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="358">[]</span><span class="p">,</span><span class="w"> </span><span class="ss">skipper</span><span class="p">:</span><span class="w"> </span><span class="no">nil</span><span class="p">,</span><span class="w"> </span><span class="ss">state</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="367">%{}</span><span class="p">,</span><span class="w"> </span><span class="ss">userdata</span><span class="p">:</span><span class="w"> </span><span class="no">nil</span><span class="p" data-group-id="369">}</span><span class="p">,</span><span class="w">
  </span><span class="ss">extradata</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="464">%</span><span class="nc" data-group-id="464">ExSpirit.Parser.Context</span><span class="p" data-group-id="464">{</span><span class="ss">column</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
   </span><span class="ss">error</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="436">%</span><span class="nc" data-group-id="436">ExSpirit.Parser.ParseException</span><span class="p" data-group-id="436">{</span><span class="ss">context</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="417">%</span><span class="nc" data-group-id="417">ExSpirit.Parser.Context</span><span class="p" data-group-id="417">{</span><span class="ss">column</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
     </span><span class="ss">error</span><span class="p">:</span><span class="w"> </span><span class="no">nil</span><span class="p">,</span><span class="w"> </span><span class="ss">filename</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;&lt;unknown&gt;&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">line</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="ss">position</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="ss">rest</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;x&quot;</span><span class="p">,</span><span class="w">
     </span><span class="ss">result</span><span class="p">:</span><span class="w"> </span><span class="no">nil</span><span class="p">,</span><span class="w"> </span><span class="ss">rulestack</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="410">[</span><span class="ss">:e</span><span class="p" data-group-id="410">]</span><span class="p">,</span><span class="w"> </span><span class="ss">skipper</span><span class="p">:</span><span class="w"> </span><span class="no">nil</span><span class="p">,</span><span class="w"> </span><span class="ss">state</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="415">%{}</span><span class="p">,</span><span class="w"> </span><span class="ss">userdata</span><span class="p">:</span><span class="w"> </span><span class="no">nil</span><span class="p" data-group-id="417">}</span><span class="p">,</span><span class="w">
    </span><span class="ss">extradata</span><span class="p">:</span><span class="w"> </span><span class="no">nil</span><span class="p">,</span><span class="w">
    </span><span class="ss">message</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Tried parsing out any of the the characters of `'a'` but failed due to the input character not matching&quot;</span><span class="p" data-group-id="436">}</span><span class="p">,</span><span class="w">
   </span><span class="ss">filename</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;&lt;unknown&gt;&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">line</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="ss">position</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="ss">rest</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;x&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">result</span><span class="p">:</span><span class="w"> </span><span class="no">nil</span><span class="p">,</span><span class="w">
   </span><span class="ss">rulestack</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="454">[]</span><span class="p">,</span><span class="w"> </span><span class="ss">skipper</span><span class="p">:</span><span class="w"> </span><span class="no">nil</span><span class="p">,</span><span class="w"> </span><span class="ss">state</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="462">%{}</span><span class="p">,</span><span class="w"> </span><span class="ss">userdata</span><span class="p">:</span><span class="w"> </span><span class="no">nil</span><span class="p" data-group-id="464">}</span><span class="p">,</span><span class="w">
  </span><span class="ss">message</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Lookahead failed&quot;</span><span class="p" data-group-id="466">}</span><span class="p">,</span><span class="w"> </span><span class="ss">filename</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;&lt;unknown&gt;&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">line</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="ss">position</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w">
 </span><span class="ss">rest</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;x&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">result</span><span class="p">:</span><span class="w"> </span><span class="no">nil</span><span class="p">,</span><span class="w"> </span><span class="ss">rulestack</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="487">[]</span><span class="p">,</span><span class="w"> </span><span class="ss">skipper</span><span class="p">:</span><span class="w"> </span><span class="no">nil</span><span class="p">,</span><span class="w"> </span><span class="ss">state</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="490">%{}</span><span class="p">,</span><span class="w"> </span><span class="ss">userdata</span><span class="p">:</span><span class="w"> </span><span class="no">nil</span><span class="p" data-group-id="492">}</span></code></pre>
<h3 id="not-predicate-lookahead_not" class="section-heading">
  <a href="#not-predicate-lookahead_not" class="hover-link"><span class="icon-link" aria-hidden="true"></span></a>
  Not-Predicate - <code class="inline">lookahead_not</code>
</h3>

<pre><code class="nohighlight makeup"><span class="gp">iex&gt;</span><span class="w"> </span><span class="n">parse</span><span class="p" data-group-id="20">(</span><span class="s2">&quot;x&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">lookahead_not</span><span class="p" data-group-id="19">(</span><span class="n">e</span><span class="p" data-group-id="19">)</span><span class="p" data-group-id="20">)</span><span class="w">
</span><span class="p" data-group-id="249">%</span><span class="nc" data-group-id="249">ExSpirit.Parser.Context</span><span class="p" data-group-id="249">{</span><span class="ss">column</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="ss">error</span><span class="p">:</span><span class="w"> </span><span class="no">nil</span><span class="p">,</span><span class="w"> </span><span class="ss">filename</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;&lt;unknown&gt;&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">line</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
 </span><span class="ss">position</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="ss">rest</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;x&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">result</span><span class="p">:</span><span class="w"> </span><span class="no">nil</span><span class="p">,</span><span class="w"> </span><span class="ss">rulestack</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="190">[]</span><span class="p">,</span><span class="w"> </span><span class="ss">skipper</span><span class="p">:</span><span class="w"> </span><span class="no">nil</span><span class="p">,</span><span class="w"> </span><span class="ss">state</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="219">%{}</span><span class="p">,</span><span class="w">
 </span><span class="ss">userdata</span><span class="p">:</span><span class="w"> </span><span class="no">nil</span><span class="p" data-group-id="249">}</span><span class="w">

</span><span class="gp">iex&gt;</span><span class="w"> </span><span class="n">parse</span><span class="p" data-group-id="277">(</span><span class="s2">&quot;a&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">lookahead_not</span><span class="p" data-group-id="276">(</span><span class="n">e</span><span class="p" data-group-id="276">)</span><span class="p" data-group-id="277">)</span><span class="w">
</span><span class="p" data-group-id="435">%</span><span class="nc" data-group-id="435">ExSpirit.Parser.Context</span><span class="p" data-group-id="435">{</span><span class="ss">column</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
 </span><span class="ss">error</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="394">%</span><span class="nc" data-group-id="394">ExSpirit.Parser.ParseException</span><span class="p" data-group-id="394">{</span><span class="ss">context</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="337">%</span><span class="nc" data-group-id="337">ExSpirit.Parser.Context</span><span class="p" data-group-id="337">{</span><span class="ss">column</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
   </span><span class="ss">error</span><span class="p">:</span><span class="w"> </span><span class="no">nil</span><span class="p">,</span><span class="w"> </span><span class="ss">filename</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;&lt;unknown&gt;&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">line</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="ss">position</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="ss">rest</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;a&quot;</span><span class="p">,</span><span class="w">
   </span><span class="ss">result</span><span class="p">:</span><span class="w"> </span><span class="no">nil</span><span class="p">,</span><span class="w"> </span><span class="ss">rulestack</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="319">[]</span><span class="p">,</span><span class="w"> </span><span class="ss">skipper</span><span class="p">:</span><span class="w"> </span><span class="no">nil</span><span class="p">,</span><span class="w"> </span><span class="ss">state</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="331">%{}</span><span class="p">,</span><span class="w"> </span><span class="ss">userdata</span><span class="p">:</span><span class="w"> </span><span class="no">nil</span><span class="p" data-group-id="337">}</span><span class="p">,</span><span class="w">
  </span><span class="ss">extradata</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="386">%</span><span class="nc" data-group-id="386">ExSpirit.Parser.Context</span><span class="p" data-group-id="386">{</span><span class="ss">column</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="ss">error</span><span class="p">:</span><span class="w"> </span><span class="no">nil</span><span class="p">,</span><span class="w">
   </span><span class="ss">filename</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;&lt;unknown&gt;&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">line</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="ss">position</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="ss">rest</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">result</span><span class="p">:</span><span class="w"> </span><span class="mi">97</span><span class="p">,</span><span class="w">
   </span><span class="ss">rulestack</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="377">[]</span><span class="p">,</span><span class="w"> </span><span class="ss">skipper</span><span class="p">:</span><span class="w"> </span><span class="no">nil</span><span class="p">,</span><span class="w"> </span><span class="ss">state</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="384">%{}</span><span class="p">,</span><span class="w"> </span><span class="ss">userdata</span><span class="p">:</span><span class="w"> </span><span class="no">nil</span><span class="p" data-group-id="386">}</span><span class="p">,</span><span class="w">
  </span><span class="ss">message</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Lookahead_not failed&quot;</span><span class="p" data-group-id="394">}</span><span class="p">,</span><span class="w"> </span><span class="ss">filename</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;&lt;unknown&gt;&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">line</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="ss">position</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w">
 </span><span class="ss">rest</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;a&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">result</span><span class="p">:</span><span class="w"> </span><span class="no">nil</span><span class="p">,</span><span class="w"> </span><span class="ss">rulestack</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="416">[]</span><span class="p">,</span><span class="w"> </span><span class="ss">skipper</span><span class="p">:</span><span class="w"> </span><span class="no">nil</span><span class="p">,</span><span class="w"> </span><span class="ss">state</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="429">%{}</span><span class="p">,</span><span class="w"> </span><span class="ss">userdata</span><span class="p">:</span><span class="w"> </span><span class="no">nil</span><span class="p" data-group-id="435">}</span></code></pre>
<h2 id="parser-composition-vs-seq" class="section-heading">
  <a href="#parser-composition-vs-seq" class="hover-link"><span class="icon-link" aria-hidden="true"></span></a>
  Parser Composition <em>vs</em> <code class="inline">seq</code>
</h2>

<p>TODO: explain the difference between <code class="inline">seq([p1, p2])</code> and <code class="inline">p1 |&gt; p2</code>.</p>
<h2 id="examples" class="section-heading">
  <a href="#examples" class="hover-link"><span class="icon-link" aria-hidden="true"></span></a>
  Examples
</h2>

<h3 id="example-a-calculator" class="section-heading">
  <a href="#example-a-calculator" class="hover-link"><span class="icon-link" aria-hidden="true"></span></a>
  Example - A Calculator
</h3>

<p>TODO</p>
<h4>Evaluator for arithmetic expressions</h4>
<h3 id="example-parsing-a-string" class="section-heading">
  <a href="#example-parsing-a-string" class="hover-link"><span class="icon-link" aria-hidden="true"></span></a>
  Example - Parsing a String
</h3>

<p>You might be tempted to use something like regular expressions to parse a string.
However, parsing strings can be complex because of escaping rules and other complications.
It’s easy with ExSpirit, though.</p>
<p>TODO</p>
<h3 id="example-a-parser-for-peg-grammars" class="section-heading">
  <a href="#example-a-parser-for-peg-grammars" class="hover-link"><span class="icon-link" aria-hidden="true"></span></a>
  Example - A Parser for PEG Grammars
</h3>

<p>The parser is pretty simple (TODO: decompose into smaller chunks and explain them):</p>
<pre><code class="nohighlight makeup"><span class="kd">defmodule</span><span class="w"> </span><span class="nc">ExSpiritTutorial.PegGrammarParser</span><span class="w"> </span><span class="k" data-group-id="26">do</span><span class="w">
  </span><span class="kn">use</span><span class="w"> </span><span class="nc">ExSpirit.Parser</span><span class="p">,</span><span class="w"> </span><span class="ss">text</span><span class="p">:</span><span class="w"> </span><span class="no">true</span><span class="w">
</span><span class="k" data-group-id="26">end</span></code></pre>
<p>The kinds of expressions we’re interested in:</p>
<pre><code class="nohighlight makeup elixir"><span class="w">  </span><span class="kd">defrule</span><span class="w"> </span><span class="nf">expression</span><span class="p" data-group-id="183">(</span><span class="w">
    </span><span class="n">alt</span><span class="p" data-group-id="182">(</span><span class="p" data-group-id="181">[</span><span class="w">
      </span><span class="n">ordered_choice</span><span class="p" data-group-id="18">()</span><span class="p">,</span><span class="w">
      </span><span class="n">sequence</span><span class="p" data-group-id="38">()</span><span class="p">,</span><span class="w">
      </span><span class="n">zero_or_more</span><span class="p" data-group-id="56">()</span><span class="p">,</span><span class="w">
      </span><span class="n">one_or_more</span><span class="p" data-group-id="88">()</span><span class="p">,</span><span class="w">
      </span><span class="n">optional</span><span class="p" data-group-id="115">()</span><span class="p">,</span><span class="w">
      </span><span class="n">group</span><span class="p" data-group-id="134">()</span><span class="p">,</span><span class="w">
      </span><span class="n">literal</span><span class="p" data-group-id="143">()</span><span class="p">,</span><span class="w">
      </span><span class="n">regex</span><span class="p" data-group-id="161">()</span><span class="p">,</span><span class="w">
      </span><span class="n">reference</span><span class="p" data-group-id="180">()</span><span class="w">
    </span><span class="p" data-group-id="181">]</span><span class="p" data-group-id="182">)</span><span class="w">
  </span><span class="p" data-group-id="183">)</span></code></pre>
<p>We’ll choose identifier naming rules to be the same as those for Elixir functions, except we’re going to disallow <code class="inline">?</code> and <code class="inline">!</code> in the names, because that would conflict with the <code class="inline">?</code> and <code class="inline">!</code> operators of the PEG Grammar.</p>
<pre><code class="nohighlight makeup elixir"><span class="w">  </span><span class="kd">defrule</span><span class="w"> </span><span class="nf">identifier</span><span class="p" data-group-id="248">(</span><span class="w">
    </span><span class="n">skip</span><span class="p" data-group-id="13">()</span><span class="w"> </span><span class="o">|&gt;</span><span class="w">
    </span><span class="n">lexeme</span><span class="p" data-group-id="247">(</span><span class="w">
      </span><span class="n">seq</span><span class="p" data-group-id="246">(</span><span class="p" data-group-id="245">[</span><span class="w">
        </span><span class="n">char</span><span class="p" data-group-id="125">(</span><span class="p" data-group-id="124">[</span><span class="sc">?a</span><span class="o">..</span><span class="sc">?z</span><span class="p">,</span><span class="w"> </span><span class="sc">?A</span><span class="o">..</span><span class="sc">?Z</span><span class="p">,</span><span class="w"> </span><span class="sc">?_</span><span class="p" data-group-id="124">]</span><span class="p" data-group-id="125">)</span><span class="p">,</span><span class="w">
        </span><span class="n">no_skip</span><span class="p" data-group-id="244">(</span><span class="n">chars</span><span class="p" data-group-id="243">(</span><span class="p" data-group-id="220">[</span><span class="sc">?a</span><span class="o">..</span><span class="sc">?z</span><span class="p">,</span><span class="w"> </span><span class="sc">?A</span><span class="o">..</span><span class="sc">?Z</span><span class="p">,</span><span class="w"> </span><span class="sc">?0</span><span class="o">..</span><span class="sc">?9</span><span class="p">,</span><span class="w"> </span><span class="sc">?_</span><span class="p" data-group-id="220">]</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p" data-group-id="243">)</span><span class="p" data-group-id="244">)</span><span class="w">
      </span><span class="p" data-group-id="245">]</span><span class="p" data-group-id="246">)</span><span class="p" data-group-id="247">)</span><span class="w">
  </span><span class="p" data-group-id="248">)</span></code></pre>
<p>Now that we’ve defined how to parse an identifier, we can define what a reference is.
A <code class="inline">reference</code> is just an identifier wrapped in a 2-tuple for easier processing.
Why did we define a separate rule to parse the identifier then?
Because it will come up useful later when we want to parse a rule name that is not a reference to a rule but the definition of a rule: the left side of <code class="inline">rule &lt;- expr</code>.</p>
<pre><code class="nohighlight makeup elixir"><span class="w">  </span><span class="kd">defrule</span><span class="w"> </span><span class="nf">reference</span><span class="p" data-group-id="25">(</span><span class="w">
    </span><span class="n">tag</span><span class="p" data-group-id="24">(</span><span class="ss">:reference</span><span class="p">,</span><span class="w"> </span><span class="n">identifier</span><span class="p" data-group-id="22">()</span><span class="p" data-group-id="24">)</span><span class="w">
  </span><span class="p" data-group-id="25">)</span></code></pre>
<pre><code class="nohighlight makeup elixir"><span class="w">  </span><span class="kd">defrule</span><span class="w"> </span><span class="nf">sequence</span><span class="p" data-group-id="234">(</span><span class="w">
    </span><span class="n">tag</span><span class="p" data-group-id="233">(</span><span class="ss">:sequence</span><span class="p">,</span><span class="w">
      </span><span class="n">repeat</span><span class="p" data-group-id="232">(</span><span class="w">
        </span><span class="n">alt</span><span class="p" data-group-id="171">(</span><span class="p" data-group-id="170">[</span><span class="w">
          </span><span class="n">zero_or_more</span><span class="p" data-group-id="48">()</span><span class="p">,</span><span class="w">
          </span><span class="n">one_or_more</span><span class="p" data-group-id="74">()</span><span class="p">,</span><span class="w">
          </span><span class="n">optional</span><span class="p" data-group-id="96">()</span><span class="p">,</span><span class="w">
          </span><span class="n">group</span><span class="p" data-group-id="123">()</span><span class="p">,</span><span class="w">
          </span><span class="n">literal</span><span class="p" data-group-id="142">()</span><span class="p">,</span><span class="w">
          </span><span class="n">regex</span><span class="p" data-group-id="157">()</span><span class="p">,</span><span class="w">
          </span><span class="n">reference</span><span class="p" data-group-id="169">()</span><span class="w">
        </span><span class="p" data-group-id="170">]</span><span class="p" data-group-id="171">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">lookahead_not</span><span class="p" data-group-id="216">(</span><span class="n">lit</span><span class="p" data-group-id="215">(</span><span class="s2">&quot;&lt;-&quot;</span><span class="p" data-group-id="215">)</span><span class="p" data-group-id="216">)</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p" data-group-id="232">)</span><span class="p" data-group-id="233">)</span><span class="w">
  </span><span class="p" data-group-id="234">)</span></code></pre>
<p>The sequence operator and the <code class="inline">ordered_choice</code> operator don’t bind as tightly, so we never will recognize a sequence before the <code class="inline">*</code>, for example.
Symbolically, <code class="inline">e1 e2 e3*</code> will be parsed as <code class="inline">e1 e2 (e3*)</code> and not as <code class="inline">(e1 e2 e3)*</code>.</p>
<p>Naturally, we won’t allow the following:</p>
<ul>
<li><code class="inline">e+*</code>
</li>
<li><code class="inline">!e*</code>
</li>
<li>etc.
</li>
</ul>
<p>We want to recognize the following, and nothing else:</p>
<ul>
<li><code class="inline">(...)*</code>
</li>
<li><code class="inline">&quot;...&quot;*</code>
</li>
<li><code class="inline">~r/.../*</code>
</li>
<li><code class="inline">e*</code>
</li>
</ul>
<p>Similar consideration will apply to the <code class="inline">?</code> and <code class="inline">+</code> operators.</p>
<pre><code class="nohighlight makeup elixir"><span class="w">  </span><span class="kd">defrule</span><span class="w"> </span><span class="nf">zero_or_more</span><span class="p" data-group-id="155">(</span><span class="w">
    </span><span class="n">tag</span><span class="p" data-group-id="154">(</span><span class="ss">:zero_or_more</span><span class="p">,</span><span class="w">
      </span><span class="n">seq</span><span class="p" data-group-id="153">(</span><span class="p" data-group-id="152">[</span><span class="w">
        </span><span class="n">alt</span><span class="p" data-group-id="133">(</span><span class="p" data-group-id="132">[</span><span class="n">group</span><span class="p" data-group-id="55">()</span><span class="p">,</span><span class="w"> </span><span class="n">literal</span><span class="p" data-group-id="86">()</span><span class="p">,</span><span class="w"> </span><span class="n">regex</span><span class="p" data-group-id="109">()</span><span class="p">,</span><span class="w"> </span><span class="n">reference</span><span class="p" data-group-id="131">()</span><span class="p" data-group-id="132">]</span><span class="p" data-group-id="133">)</span><span class="p">,</span><span class="w">
        </span><span class="n">lit</span><span class="p" data-group-id="151">(</span><span class="s2">&quot;*&quot;</span><span class="p" data-group-id="151">)</span><span class="w">
      </span><span class="p" data-group-id="152">]</span><span class="p" data-group-id="153">)</span><span class="p" data-group-id="154">)</span><span class="w">
  </span><span class="p" data-group-id="155">)</span></code></pre>
<p>The <code class="inline">+</code> (one or more) operator is similar to the above:</p>
<pre><code class="nohighlight makeup elixir"><span class="w">  </span><span class="kd">defrule</span><span class="w"> </span><span class="nf">one_or_more</span><span class="p" data-group-id="150">(</span><span class="w">
    </span><span class="n">tag</span><span class="p" data-group-id="149">(</span><span class="ss">:one_or_more</span><span class="p">,</span><span class="w">
      </span><span class="n">seq</span><span class="p" data-group-id="148">(</span><span class="p" data-group-id="147">[</span><span class="w">
        </span><span class="n">alt</span><span class="p" data-group-id="130">(</span><span class="p" data-group-id="129">[</span><span class="n">group</span><span class="p" data-group-id="57">()</span><span class="p">,</span><span class="w"> </span><span class="n">literal</span><span class="p" data-group-id="75">()</span><span class="p">,</span><span class="w"> </span><span class="n">regex</span><span class="p" data-group-id="99">()</span><span class="p">,</span><span class="w"> </span><span class="n">reference</span><span class="p" data-group-id="128">()</span><span class="p" data-group-id="129">]</span><span class="p" data-group-id="130">)</span><span class="p">,</span><span class="w">
        </span><span class="n">lit</span><span class="p" data-group-id="146">(</span><span class="s2">&quot;+&quot;</span><span class="p" data-group-id="146">)</span><span class="w">
      </span><span class="p" data-group-id="147">]</span><span class="p" data-group-id="148">)</span><span class="p" data-group-id="149">)</span><span class="w">
  </span><span class="p" data-group-id="150">)</span></code></pre>
<pre><code class="nohighlight makeup elixir"><span class="w">  </span><span class="kd">defrule</span><span class="w"> </span><span class="nf">group</span><span class="p" data-group-id="94">(</span><span class="w">
    </span><span class="n">seq</span><span class="p" data-group-id="93">(</span><span class="p" data-group-id="92">[</span><span class="n">lit</span><span class="p" data-group-id="34">(</span><span class="s2">&quot;(&quot;</span><span class="p" data-group-id="34">)</span><span class="p">,</span><span class="w"> </span><span class="n">expression</span><span class="p" data-group-id="51">()</span><span class="p">,</span><span class="w"> </span><span class="n">lit</span><span class="p" data-group-id="91">(</span><span class="s2">&quot;)&quot;</span><span class="p" data-group-id="91">)</span><span class="p" data-group-id="92">]</span><span class="p" data-group-id="93">)</span><span class="w">
  </span><span class="p" data-group-id="94">)</span></code></pre>
<pre><code class="nohighlight makeup elixir"><span class="w">  </span><span class="kd">defrule</span><span class="w"> </span><span class="nf">not_ordered_choice</span><span class="p" data-group-id="167">(</span><span class="w">
    </span><span class="n">alt</span><span class="p" data-group-id="166">(</span><span class="p" data-group-id="165">[</span><span class="w">
      </span><span class="n">sequence</span><span class="p" data-group-id="23">()</span><span class="p">,</span><span class="w">
      </span><span class="n">zero_or_more</span><span class="p" data-group-id="40">()</span><span class="p">,</span><span class="w">
      </span><span class="n">one_or_more</span><span class="p" data-group-id="61">()</span><span class="p">,</span><span class="w">
      </span><span class="n">optional</span><span class="p" data-group-id="89">()</span><span class="p">,</span><span class="w">
      </span><span class="n">group</span><span class="p" data-group-id="116">()</span><span class="p">,</span><span class="w">
      </span><span class="n">literal</span><span class="p" data-group-id="135">()</span><span class="p">,</span><span class="w">
      </span><span class="n">regex</span><span class="p" data-group-id="144">()</span><span class="p">,</span><span class="w">
      </span><span class="n">reference</span><span class="p" data-group-id="164">()</span><span class="w">
    </span><span class="p" data-group-id="165">]</span><span class="p" data-group-id="166">)</span><span class="w">
  </span><span class="p" data-group-id="167">)</span></code></pre>
<pre><code class="nohighlight makeup elixir"><span class="w">  </span><span class="kd">defrule</span><span class="w"> </span><span class="nf">ordered_choice</span><span class="p" data-group-id="139">(</span><span class="w">
    </span><span class="n">seq</span><span class="p" data-group-id="138">(</span><span class="p" data-group-id="137">[</span><span class="w">
      </span><span class="n">not_ordered_choice</span><span class="p" data-group-id="27">()</span><span class="p">,</span><span class="w">
      </span><span class="n">repeat</span><span class="p" data-group-id="136">(</span><span class="w">
        </span><span class="n">seq</span><span class="p" data-group-id="122">(</span><span class="p" data-group-id="121">[</span><span class="n">lit</span><span class="p" data-group-id="95">(</span><span class="s2">&quot;/&quot;</span><span class="p" data-group-id="95">)</span><span class="p">,</span><span class="w"> </span><span class="n">not_ordered_choice</span><span class="p" data-group-id="120">()</span><span class="p" data-group-id="121">]</span><span class="p" data-group-id="122">)</span><span class="p">,</span><span class="w">
        </span><span class="mi">1</span><span class="p" data-group-id="136">)</span><span class="w">
    </span><span class="p" data-group-id="137">]</span><span class="p" data-group-id="138">)</span><span class="w">
  </span><span class="p" data-group-id="139">)</span><span class="p">,</span><span class="w"> </span><span class="ss">pipe_result_into</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="213">(</span><span class="k" data-group-id="212">fn</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">-&gt;</span><span class="w">
        </span><span class="p" data-group-id="211">{</span><span class="ss">:ordered_choice</span><span class="p">,</span><span class="w"> </span><span class="nc">List</span><span class="o">.</span><span class="n">flatten</span><span class="p" data-group-id="210">(</span><span class="n">result</span><span class="p" data-group-id="210">)</span><span class="p" data-group-id="211">}</span><span class="w"> </span><span class="k" data-group-id="212">end</span><span class="p" data-group-id="213">)</span><span class="o">.</span><span class="p" data-group-id="222">()</span></code></pre>
<pre><code class="nohighlight makeup elixir"><span class="w">  </span><span class="kd">defrule</span><span class="w"> </span><span class="nf">literal</span><span class="p" data-group-id="226">(</span><span class="w">
    </span><span class="n">seq</span><span class="p" data-group-id="225">(</span><span class="p" data-group-id="224">[</span><span class="w">
      </span><span class="n">lit</span><span class="p" data-group-id="36">(</span><span class="s2">&quot;</span><span class="se">\&quot;</span><span class="s2">&quot;</span><span class="p" data-group-id="36">)</span><span class="p">,</span><span class="w">
      </span><span class="n">lexeme</span><span class="p" data-group-id="198">(</span><span class="w">
        </span><span class="n">repeat</span><span class="p" data-group-id="197">(</span><span class="w">
          </span><span class="n">lookahead_not</span><span class="p" data-group-id="98">(</span><span class="n">char</span><span class="p" data-group-id="97">(</span><span class="sc">?&quot;</span><span class="p" data-group-id="97">)</span><span class="p" data-group-id="98">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w">
          </span><span class="n">alt</span><span class="p" data-group-id="196">(</span><span class="p" data-group-id="195">[</span><span class="w">
            </span><span class="n">seq</span><span class="p" data-group-id="174">(</span><span class="p" data-group-id="173">[</span><span class="n">char</span><span class="p" data-group-id="158">(</span><span class="sc">?\\</span><span class="p" data-group-id="158">)</span><span class="p">,</span><span class="w"> </span><span class="n">char</span><span class="p" data-group-id="172">()</span><span class="p" data-group-id="173">]</span><span class="p" data-group-id="174">)</span><span class="p">,</span><span class="w">
            </span><span class="n">char</span><span class="p" data-group-id="194">()</span><span class="p" data-group-id="195">]</span><span class="p" data-group-id="196">)</span><span class="p" data-group-id="197">)</span><span class="p" data-group-id="198">)</span><span class="p">,</span><span class="w">
      </span><span class="n">lit</span><span class="p" data-group-id="223">(</span><span class="s2">&quot;</span><span class="se">\&quot;</span><span class="s2">&quot;</span><span class="p" data-group-id="223">)</span><span class="p" data-group-id="224">]</span><span class="p" data-group-id="225">)</span><span class="w">
  </span><span class="p" data-group-id="226">)</span><span class="p">,</span><span class="w"> </span><span class="ss">pipe_result_into</span><span class="p">:</span><span class="w"> </span><span class="n">postprocess_literal</span></code></pre>
<pre><code class="nohighlight makeup elixir"><span class="w">  </span><span class="kd">defp</span><span class="w"> </span><span class="nf">postprocess_literal</span><span class="p" data-group-id="12">(</span><span class="n">result</span><span class="p" data-group-id="12">)</span><span class="w"> </span><span class="k" data-group-id="118">do</span><span class="w">
    </span><span class="p" data-group-id="111">{</span><span class="ss">:literal</span><span class="p">,</span><span class="w"> </span><span class="nc">String</span><span class="o">.</span><span class="n">replace</span><span class="p" data-group-id="110">(</span><span class="n">result</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;</span><span class="se">\\\&quot;</span><span class="s2">&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;</span><span class="se">\&quot;</span><span class="s2">&quot;</span><span class="p" data-group-id="110">)</span><span class="p" data-group-id="111">}</span><span class="w">
  </span><span class="k" data-group-id="118">end</span></code></pre>
<pre><code class="nohighlight makeup elixir"><span class="w">  </span><span class="kd">defrule</span><span class="w"> </span><span class="nf">regex</span><span class="p" data-group-id="230">(</span><span class="w">
    </span><span class="n">seq</span><span class="p" data-group-id="229">(</span><span class="p" data-group-id="228">[</span><span class="w">
      </span><span class="n">lit</span><span class="p" data-group-id="35">(</span><span class="s2">&quot;~r/&quot;</span><span class="p" data-group-id="35">)</span><span class="p">,</span><span class="w">
      </span><span class="n">lexeme</span><span class="p" data-group-id="203">(</span><span class="w">
        </span><span class="n">repeat</span><span class="p" data-group-id="202">(</span><span class="w">
          </span><span class="n">lookahead_not</span><span class="p" data-group-id="101">(</span><span class="n">char</span><span class="p" data-group-id="100">(</span><span class="sc">?/</span><span class="p" data-group-id="100">)</span><span class="p" data-group-id="101">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w">
          </span><span class="n">alt</span><span class="p" data-group-id="201">(</span><span class="p" data-group-id="200">[</span><span class="w">
            </span><span class="n">seq</span><span class="p" data-group-id="178">(</span><span class="p" data-group-id="177">[</span><span class="n">char</span><span class="p" data-group-id="159">(</span><span class="sc">?\\</span><span class="p" data-group-id="159">)</span><span class="p">,</span><span class="w"> </span><span class="n">char</span><span class="p" data-group-id="176">()</span><span class="p" data-group-id="177">]</span><span class="p" data-group-id="178">)</span><span class="p">,</span><span class="w">
            </span><span class="n">char</span><span class="p" data-group-id="199">()</span><span class="p" data-group-id="200">]</span><span class="p" data-group-id="201">)</span><span class="p" data-group-id="202">)</span><span class="p" data-group-id="203">)</span><span class="p">,</span><span class="w">
      </span><span class="n">lit</span><span class="p" data-group-id="227">(</span><span class="s2">&quot;/&quot;</span><span class="p" data-group-id="227">)</span><span class="p" data-group-id="228">]</span><span class="p" data-group-id="229">)</span><span class="w">
  </span><span class="p" data-group-id="230">)</span><span class="p">,</span><span class="w"> </span><span class="ss">pipe_result_into</span><span class="p">:</span><span class="w"> </span><span class="n">postprocess_regex</span></code></pre>
<pre><code class="nohighlight makeup elixir"><span class="w">  </span><span class="kd">defp</span><span class="w"> </span><span class="nf">postprocess_regex</span><span class="p" data-group-id="14">(</span><span class="n">result</span><span class="p" data-group-id="14">)</span><span class="w"> </span><span class="k" data-group-id="208">do</span><span class="w">
    </span><span class="n">unescaped</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">String</span><span class="o">.</span><span class="n">replace</span><span class="p" data-group-id="102">(</span><span class="n">result</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;</span><span class="se">\\</span><span class="s2">/&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;/&quot;</span><span class="p" data-group-id="102">)</span><span class="w">
    </span><span class="n">pattern</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;^&quot;</span><span class="w"> </span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">unescaped</span><span class="w">
    </span><span class="n">regex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Regex</span><span class="o">.</span><span class="n">compile!</span><span class="p" data-group-id="185">(</span><span class="n">pattern</span><span class="p" data-group-id="185">)</span><span class="w">
    </span><span class="p" data-group-id="205">{</span><span class="ss">:regex</span><span class="p">,</span><span class="w"> </span><span class="n">regex</span><span class="p" data-group-id="205">}</span><span class="w">
  </span><span class="k" data-group-id="208">end</span></code></pre>
<p>Now that we can recognize all the operations we’ll support, let’s add the ability to parse grammar rules. Remember, a rule has the form:</p>
<pre><code class="plaintext">identifier &lt;- expression</code></pre>
<p>Translating this to ExSpirit is straightforward. We’ll represent rules by a 2-tuple <code class="inline">{name, expression}</code>.</p>
<pre><code class="nohighlight makeup elixir"><span class="w">  </span><span class="kd">defrule</span><span class="w"> </span><span class="nf">rule</span><span class="p" data-group-id="73">(</span><span class="w">
    </span><span class="n">seq</span><span class="p" data-group-id="72">(</span><span class="p" data-group-id="71">[</span><span class="w">
      </span><span class="n">identifier</span><span class="p" data-group-id="28">()</span><span class="p">,</span><span class="w"> </span><span class="n">lit</span><span class="p" data-group-id="52">(</span><span class="s2">&quot;&lt;-&quot;</span><span class="p" data-group-id="52">)</span><span class="p">,</span><span class="w"> </span><span class="n">expression</span><span class="p" data-group-id="70">()</span><span class="w">
    </span><span class="p" data-group-id="71">]</span><span class="p" data-group-id="72">)</span><span class="w">
  </span><span class="p" data-group-id="73">)</span><span class="p">,</span><span class="w"> </span><span class="ss">pipe_result_into</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="163">(</span><span class="k" data-group-id="162">fn</span><span class="w"> </span><span class="p" data-group-id="140">[</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">body</span><span class="p" data-group-id="140">]</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p" data-group-id="160">{</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">body</span><span class="p" data-group-id="160">}</span><span class="w"> </span><span class="k" data-group-id="162">end</span><span class="p" data-group-id="163">)</span><span class="o">.</span><span class="p" data-group-id="175">()</span></code></pre>
<p>Now, let’s finish the parser by teaching it how to recognize a valid string containing many rules.
While in real life you might want to represent one rule per line, the syntax is not sensitive to whitespace, so we only need to keep trying to parse rules one after the other.
When all rules have been parsed, only whitespace should remain.
We’ll detect this with the <code class="inline">eoi()</code> (end of input) parser:</p>
<pre><code class="nohighlight makeup elixir"><span class="w">  </span><span class="kd">defrule</span><span class="w"> </span><span class="nf">rules</span><span class="p" data-group-id="108">(</span><span class="w">
    </span><span class="n">seq</span><span class="p" data-group-id="107">(</span><span class="p" data-group-id="106">[</span><span class="w">
      </span><span class="n">repeat</span><span class="p" data-group-id="41">(</span><span class="n">rule</span><span class="p" data-group-id="31">()</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p" data-group-id="41">)</span><span class="p">,</span><span class="w">
      </span><span class="n">ignore</span><span class="p" data-group-id="83">(</span><span class="n">skip</span><span class="p" data-group-id="82">()</span><span class="p" data-group-id="83">)</span><span class="p">,</span><span class="w">
      </span><span class="n">eoi</span><span class="p" data-group-id="105">()</span><span class="w">
    </span><span class="p" data-group-id="106">]</span><span class="p" data-group-id="107">)</span><span class="w">
  </span><span class="p" data-group-id="108">)</span></code></pre>
<p>Finally, we’ll hide all this complexity behind a nice API, so that users of our module don’t need to deal with ExSpirit-specific details (like <code class="inline">parse()</code>, setting a skipper, etc.)</p>
<pre><code class="nohighlight makeup elixir"><span class="w">  </span><span class="kd">def</span><span class="w"> </span><span class="nf">from_string</span><span class="p" data-group-id="9">(</span><span class="n">string</span><span class="p" data-group-id="9">)</span><span class="w"> </span><span class="k" data-group-id="112">do</span><span class="w">
    </span><span class="n">parse</span><span class="p" data-group-id="104">(</span><span class="n">string</span><span class="p">,</span><span class="w"> </span><span class="n">rules</span><span class="p">,</span><span class="w"> </span><span class="ss">skipper</span><span class="p">:</span><span class="w"> </span><span class="n">chars</span><span class="p" data-group-id="103">(</span><span class="p" data-group-id="87">[</span><span class="sc">?\s</span><span class="p">,</span><span class="w"> </span><span class="sc">?\n</span><span class="p">,</span><span class="w"> </span><span class="sc">?\r</span><span class="p" data-group-id="87">]</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p" data-group-id="103">)</span><span class="p" data-group-id="104">)</span><span class="w">
  </span><span class="k" data-group-id="112">end</span></code></pre>
<pre><code class="nohighlight makeup elixir"><span class="w">  </span><span class="c1"># Taken from a Wikipedia example
</span><span class="w">  </span><span class="kd">def</span><span class="w"> </span><span class="nf">example_grammar</span><span class="w"> </span><span class="k" data-group-id="37">do</span><span class="w">
    </span><span class="s">~S&quot;&quot;&quot;
    expr    &lt;- sum
    sum     &lt;- product ((&quot;+&quot; / &quot;-&quot;) product)*
    product &lt;- value ((&quot;*&quot; / &quot;/&quot;) value)*
    value   &lt;- ~r/^</span><span class="se">\d</span><span class="s">+/ / &quot;(&quot; expr &quot;)&quot;
    &quot;&quot;&quot;</span><span class="w">
  </span><span class="k" data-group-id="37">end</span></code></pre>
<p>Full parser</p>
<pre><code class="nohighlight makeup elixir"><span class="kd">defmodule</span><span class="w"> </span><span class="nc">ExSpiritTutorial.PegGrammarParser</span><span class="w"> </span><span class="k" data-group-id="601">do</span><span class="w">
  </span><span class="kn">use</span><span class="w"> </span><span class="nc">ExSpirit.Parser</span><span class="p">,</span><span class="w"> </span><span class="ss">text</span><span class="p">:</span><span class="w"> </span><span class="no">true</span><span class="w">

  </span><span class="kd">defrule</span><span class="w"> </span><span class="nf">expression</span><span class="p" data-group-id="253">(</span><span class="w">
    </span><span class="n">alt</span><span class="p" data-group-id="252">(</span><span class="p" data-group-id="251">[</span><span class="w">
      </span><span class="n">ordered_choice</span><span class="p" data-group-id="90">()</span><span class="p">,</span><span class="w">
      </span><span class="n">sequence</span><span class="p" data-group-id="119">()</span><span class="p">,</span><span class="w">
      </span><span class="n">zero_or_more</span><span class="p" data-group-id="141">()</span><span class="p">,</span><span class="w">
      </span><span class="n">one_or_more</span><span class="p" data-group-id="145">()</span><span class="p">,</span><span class="w">
      </span><span class="n">optional</span><span class="p" data-group-id="168">()</span><span class="p">,</span><span class="w">
      </span><span class="n">group</span><span class="p" data-group-id="188">()</span><span class="p">,</span><span class="w">
      </span><span class="n">literal</span><span class="p" data-group-id="209">()</span><span class="p">,</span><span class="w">
      </span><span class="n">regex</span><span class="p" data-group-id="218">()</span><span class="p">,</span><span class="w">
      </span><span class="n">reference</span><span class="p" data-group-id="250">()</span><span class="w">
    </span><span class="p" data-group-id="251">]</span><span class="p" data-group-id="252">)</span><span class="w">
  </span><span class="p" data-group-id="253">)</span><span class="w">

  </span><span class="kd">defrule</span><span class="w"> </span><span class="nf">identifier</span><span class="p" data-group-id="327">(</span><span class="w">
    </span><span class="n">skip</span><span class="p" data-group-id="266">()</span><span class="w"> </span><span class="o">|&gt;</span><span class="w">
    </span><span class="n">lexeme</span><span class="p" data-group-id="326">(</span><span class="w">
      </span><span class="n">seq</span><span class="p" data-group-id="325">(</span><span class="p" data-group-id="324">[</span><span class="w">
        </span><span class="n">char</span><span class="p" data-group-id="299">(</span><span class="p" data-group-id="298">[</span><span class="sc">?a</span><span class="o">..</span><span class="sc">?z</span><span class="p">,</span><span class="w"> </span><span class="sc">?A</span><span class="o">..</span><span class="sc">?Z</span><span class="p">,</span><span class="w"> </span><span class="sc">?_</span><span class="p" data-group-id="298">]</span><span class="p" data-group-id="299">)</span><span class="p">,</span><span class="w">
        </span><span class="n">no_skip</span><span class="p" data-group-id="323">(</span><span class="n">chars</span><span class="p" data-group-id="322">(</span><span class="p" data-group-id="318">[</span><span class="sc">?a</span><span class="o">..</span><span class="sc">?z</span><span class="p">,</span><span class="w"> </span><span class="sc">?A</span><span class="o">..</span><span class="sc">?Z</span><span class="p">,</span><span class="w"> </span><span class="sc">?0</span><span class="o">..</span><span class="sc">?9</span><span class="p">,</span><span class="w"> </span><span class="sc">?_</span><span class="p" data-group-id="318">]</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p" data-group-id="322">)</span><span class="p" data-group-id="323">)</span><span class="w">
      </span><span class="p" data-group-id="324">]</span><span class="p" data-group-id="325">)</span><span class="p" data-group-id="326">)</span><span class="w">
  </span><span class="p" data-group-id="327">)</span><span class="w">

  </span><span class="kd">defrule</span><span class="w"> </span><span class="nf">reference</span><span class="p" data-group-id="340">(</span><span class="w">
    </span><span class="n">tag</span><span class="p" data-group-id="339">(</span><span class="ss">:reference</span><span class="p">,</span><span class="w"> </span><span class="n">identifier</span><span class="p" data-group-id="338">()</span><span class="p" data-group-id="339">)</span><span class="w">
  </span><span class="p" data-group-id="340">)</span><span class="w">

  </span><span class="kd">defrule</span><span class="w"> </span><span class="nf">sequence</span><span class="p" data-group-id="393">(</span><span class="w">
    </span><span class="n">tag</span><span class="p" data-group-id="392">(</span><span class="ss">:sequence</span><span class="p">,</span><span class="w">
      </span><span class="n">repeat</span><span class="p" data-group-id="391">(</span><span class="w">
        </span><span class="n">alt</span><span class="p" data-group-id="380">(</span><span class="p" data-group-id="379">[</span><span class="w">
          </span><span class="n">zero_or_more</span><span class="p" data-group-id="363">()</span><span class="p">,</span><span class="w">
          </span><span class="n">one_or_more</span><span class="p" data-group-id="364">()</span><span class="p">,</span><span class="w">
          </span><span class="n">optional</span><span class="p" data-group-id="368">()</span><span class="p">,</span><span class="w">
          </span><span class="n">group</span><span class="p" data-group-id="370">()</span><span class="p">,</span><span class="w">
          </span><span class="n">literal</span><span class="p" data-group-id="374">()</span><span class="p">,</span><span class="w">
          </span><span class="n">regex</span><span class="p" data-group-id="376">()</span><span class="p">,</span><span class="w">
          </span><span class="n">reference</span><span class="p" data-group-id="378">()</span><span class="w">
        </span><span class="p" data-group-id="379">]</span><span class="p" data-group-id="380">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">lookahead_not</span><span class="p" data-group-id="389">(</span><span class="n">lit</span><span class="p" data-group-id="388">(</span><span class="s2">&quot;&lt;-&quot;</span><span class="p" data-group-id="388">)</span><span class="p" data-group-id="389">)</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p" data-group-id="391">)</span><span class="p" data-group-id="392">)</span><span class="w">
  </span><span class="p" data-group-id="393">)</span><span class="w">

  </span><span class="kd">defrule</span><span class="w"> </span><span class="nf">zero_or_more</span><span class="p" data-group-id="428">(</span><span class="w">
    </span><span class="n">tag</span><span class="p" data-group-id="427">(</span><span class="ss">:zero_or_more</span><span class="p">,</span><span class="w">
      </span><span class="n">seq</span><span class="p" data-group-id="426">(</span><span class="p" data-group-id="425">[</span><span class="w">
        </span><span class="n">alt</span><span class="p" data-group-id="420">(</span><span class="p" data-group-id="419">[</span><span class="n">group</span><span class="p" data-group-id="408">()</span><span class="p">,</span><span class="w"> </span><span class="n">literal</span><span class="p" data-group-id="411">()</span><span class="p">,</span><span class="w"> </span><span class="n">regex</span><span class="p" data-group-id="414">()</span><span class="p">,</span><span class="w"> </span><span class="n">reference</span><span class="p" data-group-id="418">()</span><span class="p" data-group-id="419">]</span><span class="p" data-group-id="420">)</span><span class="p">,</span><span class="w">
        </span><span class="n">lit</span><span class="p" data-group-id="424">(</span><span class="s2">&quot;*&quot;</span><span class="p" data-group-id="424">)</span><span class="w">
      </span><span class="p" data-group-id="425">]</span><span class="p" data-group-id="426">)</span><span class="p" data-group-id="427">)</span><span class="w">
  </span><span class="p" data-group-id="428">)</span><span class="w">

  </span><span class="kd">defrule</span><span class="w"> </span><span class="nf">one_or_more</span><span class="p" data-group-id="459">(</span><span class="w">
    </span><span class="n">tag</span><span class="p" data-group-id="458">(</span><span class="ss">:one_or_more</span><span class="p">,</span><span class="w">
      </span><span class="n">seq</span><span class="p" data-group-id="457">(</span><span class="p" data-group-id="456">[</span><span class="w">
        </span><span class="n">alt</span><span class="p" data-group-id="451">(</span><span class="p" data-group-id="450">[</span><span class="n">group</span><span class="p" data-group-id="439">()</span><span class="p">,</span><span class="w"> </span><span class="n">literal</span><span class="p" data-group-id="440">()</span><span class="p">,</span><span class="w"> </span><span class="n">regex</span><span class="p" data-group-id="442">()</span><span class="p">,</span><span class="w"> </span><span class="n">reference</span><span class="p" data-group-id="449">()</span><span class="p" data-group-id="450">]</span><span class="p" data-group-id="451">)</span><span class="p">,</span><span class="w">
        </span><span class="n">lit</span><span class="p" data-group-id="455">(</span><span class="s2">&quot;+&quot;</span><span class="p" data-group-id="455">)</span><span class="w">
      </span><span class="p" data-group-id="456">]</span><span class="p" data-group-id="457">)</span><span class="p" data-group-id="458">)</span><span class="w">
  </span><span class="p" data-group-id="459">)</span><span class="w">

  </span><span class="kd">defrule</span><span class="w"> </span><span class="nf">optional</span><span class="p" data-group-id="485">(</span><span class="w">
    </span><span class="n">tag</span><span class="p" data-group-id="484">(</span><span class="ss">:optional</span><span class="p">,</span><span class="w">
      </span><span class="n">seq</span><span class="p" data-group-id="483">(</span><span class="p" data-group-id="482">[</span><span class="w">
        </span><span class="n">alt</span><span class="p" data-group-id="479">(</span><span class="p" data-group-id="478">[</span><span class="n">group</span><span class="p" data-group-id="470">()</span><span class="p">,</span><span class="w"> </span><span class="n">literal</span><span class="p" data-group-id="473">()</span><span class="p">,</span><span class="w"> </span><span class="n">regex</span><span class="p" data-group-id="474">()</span><span class="p">,</span><span class="w"> </span><span class="n">reference</span><span class="p" data-group-id="477">()</span><span class="p" data-group-id="478">]</span><span class="p" data-group-id="479">)</span><span class="p">,</span><span class="w">
        </span><span class="n">lit</span><span class="p" data-group-id="481">(</span><span class="s2">&quot;?&quot;</span><span class="p" data-group-id="481">)</span><span class="w">
      </span><span class="p" data-group-id="482">]</span><span class="p" data-group-id="483">)</span><span class="p" data-group-id="484">)</span><span class="w">
  </span><span class="p" data-group-id="485">)</span><span class="w">

  </span><span class="kd">defrule</span><span class="w"> </span><span class="nf">group</span><span class="p" data-group-id="496">(</span><span class="w">
    </span><span class="n">seq</span><span class="p" data-group-id="495">(</span><span class="p" data-group-id="494">[</span><span class="n">lit</span><span class="p" data-group-id="489">(</span><span class="s2">&quot;(&quot;</span><span class="p" data-group-id="489">)</span><span class="p">,</span><span class="w"> </span><span class="n">expression</span><span class="p" data-group-id="491">()</span><span class="p">,</span><span class="w"> </span><span class="n">lit</span><span class="p" data-group-id="493">(</span><span class="s2">&quot;)&quot;</span><span class="p" data-group-id="493">)</span><span class="p" data-group-id="494">]</span><span class="p" data-group-id="495">)</span><span class="w">
  </span><span class="p" data-group-id="496">)</span><span class="w">

  </span><span class="kd">defrule</span><span class="w"> </span><span class="nf">not_ordered_choice</span><span class="p" data-group-id="516">(</span><span class="w">
    </span><span class="n">alt</span><span class="p" data-group-id="515">(</span><span class="p" data-group-id="514">[</span><span class="w">
      </span><span class="n">sequence</span><span class="p" data-group-id="498">()</span><span class="p">,</span><span class="w">
      </span><span class="n">zero_or_more</span><span class="p" data-group-id="501">()</span><span class="p">,</span><span class="w">
      </span><span class="n">one_or_more</span><span class="p" data-group-id="503">()</span><span class="p">,</span><span class="w">
      </span><span class="n">optional</span><span class="p" data-group-id="506">()</span><span class="p">,</span><span class="w">
      </span><span class="n">group</span><span class="p" data-group-id="509">()</span><span class="p">,</span><span class="w">
      </span><span class="n">literal</span><span class="p" data-group-id="510">()</span><span class="p">,</span><span class="w">
      </span><span class="n">regex</span><span class="p" data-group-id="512">()</span><span class="p">,</span><span class="w">
      </span><span class="n">reference</span><span class="p" data-group-id="513">()</span><span class="w">
    </span><span class="p" data-group-id="514">]</span><span class="p" data-group-id="515">)</span><span class="w">
  </span><span class="p" data-group-id="516">)</span><span class="w">

  </span><span class="kd">defrule</span><span class="w"> </span><span class="nf">ordered_choice</span><span class="p" data-group-id="529">(</span><span class="w">
    </span><span class="n">seq</span><span class="p" data-group-id="528">(</span><span class="p" data-group-id="527">[</span><span class="w">
      </span><span class="n">not_ordered_choice</span><span class="p" data-group-id="519">()</span><span class="p">,</span><span class="w">
      </span><span class="n">repeat</span><span class="p" data-group-id="526">(</span><span class="w">
        </span><span class="n">seq</span><span class="p" data-group-id="525">(</span><span class="p" data-group-id="524">[</span><span class="n">lit</span><span class="p" data-group-id="522">(</span><span class="s2">&quot;/&quot;</span><span class="p" data-group-id="522">)</span><span class="p">,</span><span class="w"> </span><span class="n">not_ordered_choice</span><span class="p" data-group-id="523">()</span><span class="p" data-group-id="524">]</span><span class="p" data-group-id="525">)</span><span class="p">,</span><span class="w">
        </span><span class="mi">1</span><span class="p" data-group-id="526">)</span><span class="w">
    </span><span class="p" data-group-id="527">]</span><span class="p" data-group-id="528">)</span><span class="w">
  </span><span class="p" data-group-id="529">)</span><span class="p">,</span><span class="w"> </span><span class="ss">pipe_result_into</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="533">(</span><span class="k" data-group-id="532">fn</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">-&gt;</span><span class="w">
        </span><span class="p" data-group-id="531">{</span><span class="ss">:ordered_choice</span><span class="p">,</span><span class="w"> </span><span class="nc">List</span><span class="o">.</span><span class="n">flatten</span><span class="p" data-group-id="530">(</span><span class="n">result</span><span class="p" data-group-id="530">)</span><span class="p" data-group-id="531">}</span><span class="w"> </span><span class="k" data-group-id="532">end</span><span class="p" data-group-id="533">)</span><span class="o">.</span><span class="p" data-group-id="534">()</span><span class="w">

  </span><span class="kd">defrule</span><span class="w"> </span><span class="nf">literal</span><span class="p" data-group-id="550">(</span><span class="w">
    </span><span class="n">seq</span><span class="p" data-group-id="549">(</span><span class="p" data-group-id="548">[</span><span class="w">
      </span><span class="n">lit</span><span class="p" data-group-id="535">(</span><span class="s2">&quot;</span><span class="se">\&quot;</span><span class="s2">&quot;</span><span class="p" data-group-id="535">)</span><span class="p">,</span><span class="w">
      </span><span class="n">lexeme</span><span class="p" data-group-id="546">(</span><span class="w">
        </span><span class="n">repeat</span><span class="p" data-group-id="545">(</span><span class="w">
          </span><span class="n">lookahead_not</span><span class="p" data-group-id="537">(</span><span class="n">char</span><span class="p" data-group-id="536">(</span><span class="sc">?&quot;</span><span class="p" data-group-id="536">)</span><span class="p" data-group-id="537">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w">
          </span><span class="n">alt</span><span class="p" data-group-id="544">(</span><span class="p" data-group-id="543">[</span><span class="w">
            </span><span class="n">seq</span><span class="p" data-group-id="541">(</span><span class="p" data-group-id="540">[</span><span class="n">char</span><span class="p" data-group-id="538">(</span><span class="sc">?\\</span><span class="p" data-group-id="538">)</span><span class="p">,</span><span class="w"> </span><span class="n">char</span><span class="p" data-group-id="539">()</span><span class="p" data-group-id="540">]</span><span class="p" data-group-id="541">)</span><span class="p">,</span><span class="w">
            </span><span class="n">char</span><span class="p" data-group-id="542">()</span><span class="p" data-group-id="543">]</span><span class="p" data-group-id="544">)</span><span class="p" data-group-id="545">)</span><span class="p" data-group-id="546">)</span><span class="p">,</span><span class="w">
      </span><span class="n">lit</span><span class="p" data-group-id="547">(</span><span class="s2">&quot;</span><span class="se">\&quot;</span><span class="s2">&quot;</span><span class="p" data-group-id="547">)</span><span class="p" data-group-id="548">]</span><span class="p" data-group-id="549">)</span><span class="w">
  </span><span class="p" data-group-id="550">)</span><span class="p">,</span><span class="w"> </span><span class="ss">pipe_result_into</span><span class="p">:</span><span class="w"> </span><span class="n">postprocess_literal</span><span class="w">

  </span><span class="kd">defp</span><span class="w"> </span><span class="nf">postprocess_literal</span><span class="p" data-group-id="551">(</span><span class="n">result</span><span class="p" data-group-id="551">)</span><span class="w"> </span><span class="k" data-group-id="554">do</span><span class="w">
    </span><span class="p" data-group-id="553">{</span><span class="ss">:literal</span><span class="p">,</span><span class="w"> </span><span class="nc">String</span><span class="o">.</span><span class="n">replace</span><span class="p" data-group-id="552">(</span><span class="n">result</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;</span><span class="se">\\\&quot;</span><span class="s2">&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;</span><span class="se">\&quot;</span><span class="s2">&quot;</span><span class="p" data-group-id="552">)</span><span class="p" data-group-id="553">}</span><span class="w">
  </span><span class="k" data-group-id="554">end</span><span class="w">

  </span><span class="kd">defrule</span><span class="w"> </span><span class="nf">regex</span><span class="p" data-group-id="570">(</span><span class="w">
    </span><span class="n">seq</span><span class="p" data-group-id="569">(</span><span class="p" data-group-id="568">[</span><span class="w">
      </span><span class="n">lit</span><span class="p" data-group-id="555">(</span><span class="s2">&quot;~r/&quot;</span><span class="p" data-group-id="555">)</span><span class="p">,</span><span class="w">
      </span><span class="n">lexeme</span><span class="p" data-group-id="566">(</span><span class="w">
        </span><span class="n">repeat</span><span class="p" data-group-id="565">(</span><span class="w">
          </span><span class="n">lookahead_not</span><span class="p" data-group-id="557">(</span><span class="n">char</span><span class="p" data-group-id="556">(</span><span class="sc">?/</span><span class="p" data-group-id="556">)</span><span class="p" data-group-id="557">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w">
          </span><span class="n">alt</span><span class="p" data-group-id="564">(</span><span class="p" data-group-id="563">[</span><span class="w">
            </span><span class="n">seq</span><span class="p" data-group-id="561">(</span><span class="p" data-group-id="560">[</span><span class="n">char</span><span class="p" data-group-id="558">(</span><span class="sc">?\\</span><span class="p" data-group-id="558">)</span><span class="p">,</span><span class="w"> </span><span class="n">char</span><span class="p" data-group-id="559">()</span><span class="p" data-group-id="560">]</span><span class="p" data-group-id="561">)</span><span class="p">,</span><span class="w">
            </span><span class="n">char</span><span class="p" data-group-id="562">()</span><span class="p" data-group-id="563">]</span><span class="p" data-group-id="564">)</span><span class="p" data-group-id="565">)</span><span class="p" data-group-id="566">)</span><span class="p">,</span><span class="w">
      </span><span class="n">lit</span><span class="p" data-group-id="567">(</span><span class="s2">&quot;/&quot;</span><span class="p" data-group-id="567">)</span><span class="p" data-group-id="568">]</span><span class="p" data-group-id="569">)</span><span class="w">
  </span><span class="p" data-group-id="570">)</span><span class="p">,</span><span class="w"> </span><span class="ss">pipe_result_into</span><span class="p">:</span><span class="w"> </span><span class="n">postprocess_regex</span><span class="w">

  </span><span class="kd">defp</span><span class="w"> </span><span class="nf">postprocess_regex</span><span class="p" data-group-id="571">(</span><span class="n">result</span><span class="p" data-group-id="571">)</span><span class="w"> </span><span class="k" data-group-id="575">do</span><span class="w">
    </span><span class="n">unescaped</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">String</span><span class="o">.</span><span class="n">replace</span><span class="p" data-group-id="572">(</span><span class="n">result</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;</span><span class="se">\\</span><span class="s2">/&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;/&quot;</span><span class="p" data-group-id="572">)</span><span class="w">
    </span><span class="n">pattern</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;^&quot;</span><span class="w"> </span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">unescaped</span><span class="w">
    </span><span class="n">regex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Regex</span><span class="o">.</span><span class="n">compile!</span><span class="p" data-group-id="573">(</span><span class="n">pattern</span><span class="p" data-group-id="573">)</span><span class="w">
    </span><span class="p" data-group-id="574">{</span><span class="ss">:regex</span><span class="p">,</span><span class="w"> </span><span class="n">regex</span><span class="p" data-group-id="574">}</span><span class="w">
  </span><span class="k" data-group-id="575">end</span><span class="w">

  </span><span class="kd">defrule</span><span class="w"> </span><span class="nf">rule</span><span class="p" data-group-id="581">(</span><span class="w">
    </span><span class="n">seq</span><span class="p" data-group-id="580">(</span><span class="p" data-group-id="579">[</span><span class="w">
      </span><span class="n">identifier</span><span class="p" data-group-id="576">()</span><span class="p">,</span><span class="w"> </span><span class="n">lit</span><span class="p" data-group-id="577">(</span><span class="s2">&quot;&lt;-&quot;</span><span class="p" data-group-id="577">)</span><span class="p">,</span><span class="w"> </span><span class="n">expression</span><span class="p" data-group-id="578">()</span><span class="w">
    </span><span class="p" data-group-id="579">]</span><span class="p" data-group-id="580">)</span><span class="w">
  </span><span class="p" data-group-id="581">)</span><span class="p">,</span><span class="w"> </span><span class="ss">pipe_result_into</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="585">(</span><span class="k" data-group-id="584">fn</span><span class="w"> </span><span class="p" data-group-id="582">[</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">body</span><span class="p" data-group-id="582">]</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p" data-group-id="583">{</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">body</span><span class="p" data-group-id="583">}</span><span class="w"> </span><span class="k" data-group-id="584">end</span><span class="p" data-group-id="585">)</span><span class="o">.</span><span class="p" data-group-id="586">()</span><span class="w">

  </span><span class="kd">defrule</span><span class="w"> </span><span class="nf">rules</span><span class="p" data-group-id="594">(</span><span class="w">
    </span><span class="n">seq</span><span class="p" data-group-id="593">(</span><span class="p" data-group-id="592">[</span><span class="w">
      </span><span class="n">repeat</span><span class="p" data-group-id="588">(</span><span class="n">rule</span><span class="p" data-group-id="587">()</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p" data-group-id="588">)</span><span class="p">,</span><span class="w">
      </span><span class="n">ignore</span><span class="p" data-group-id="590">(</span><span class="n">skip</span><span class="p" data-group-id="589">()</span><span class="p" data-group-id="590">)</span><span class="p">,</span><span class="w">
      </span><span class="n">eoi</span><span class="p" data-group-id="591">()</span><span class="w">
    </span><span class="p" data-group-id="592">]</span><span class="p" data-group-id="593">)</span><span class="w">
  </span><span class="p" data-group-id="594">)</span><span class="w">

  </span><span class="c1"># Taken from a Wikipedia example
</span><span class="w">  </span><span class="kd">def</span><span class="w"> </span><span class="nf">example_grammar</span><span class="w"> </span><span class="k" data-group-id="595">do</span><span class="w">
    </span><span class="s">~S&quot;&quot;&quot;
    expr    &lt;- sum
    sum     &lt;- product ((&quot;+&quot; / &quot;-&quot;) product)*
    product &lt;- value ((&quot;*&quot; / &quot;/&quot;) value)*
    value   &lt;- ~r/^</span><span class="se">\d</span><span class="s">+/ / &quot;(&quot; expr &quot;)&quot;
    &quot;&quot;&quot;</span><span class="w">
  </span><span class="k" data-group-id="595">end</span><span class="w">

  </span><span class="kd">def</span><span class="w"> </span><span class="nf">from_string</span><span class="p" data-group-id="596">(</span><span class="n">string</span><span class="p" data-group-id="596">)</span><span class="w"> </span><span class="k" data-group-id="600">do</span><span class="w">
    </span><span class="n">parse</span><span class="p" data-group-id="599">(</span><span class="n">string</span><span class="p">,</span><span class="w"> </span><span class="n">rules</span><span class="p">,</span><span class="w"> </span><span class="ss">skipper</span><span class="p">:</span><span class="w"> </span><span class="n">chars</span><span class="p" data-group-id="598">(</span><span class="p" data-group-id="597">[</span><span class="sc">?\s</span><span class="p">,</span><span class="w"> </span><span class="sc">?\n</span><span class="p">,</span><span class="w"> </span><span class="sc">?\r</span><span class="p" data-group-id="597">]</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p" data-group-id="598">)</span><span class="p" data-group-id="599">)</span><span class="w">
  </span><span class="k" data-group-id="600">end</span><span class="w">
</span><span class="k" data-group-id="601">end</span><span class="w">
</span></code></pre>
<p>Let’s just test out parser on the <code class="inline">example_rule</code> we’ve defined:</p>
<pre><code class="nohighlight makeup"><span class="gp">iex&gt;</span><span class="w"> </span><span class="kn">import</span><span class="w"> </span><span class="nc">ExSpiritTutorial.PegGrammarParser</span><span class="w">
</span><span class="nc">ExSpiritTutorial.PegGrammarParser</span><span class="w">
</span><span class="gp">iex&gt;</span><span class="w"> </span><span class="n">from_string</span><span class="p" data-group-id="11">(</span><span class="n">example_grammar</span><span class="p" data-group-id="11">)</span><span class="o">.</span><span class="n">result</span><span class="w">
</span><span class="p" data-group-id="356">[</span><span class="p" data-group-id="80">{</span><span class="s2">&quot;expr&quot;</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="78">{</span><span class="ss">:reference</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;sum&quot;</span><span class="p" data-group-id="78">}</span><span class="p" data-group-id="80">}</span><span class="p">,</span><span class="w">
 </span><span class="p" data-group-id="261">{</span><span class="s2">&quot;sum&quot;</span><span class="p">,</span><span class="w">
  </span><span class="p" data-group-id="260">{</span><span class="ss">:sequence</span><span class="p">,</span><span class="w">
   </span><span class="p" data-group-id="259">[</span><span class="ss">reference</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;product&quot;</span><span class="p">,</span><span class="w">
    </span><span class="ss">zero_or_more</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="258">{</span><span class="ss">:sequence</span><span class="p">,</span><span class="w">
     </span><span class="p" data-group-id="257">[</span><span class="ss">ordered_choice</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="239">[</span><span class="ss">literal</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;+&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">literal</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;-&quot;</span><span class="p" data-group-id="239">]</span><span class="p">,</span><span class="w"> </span><span class="ss">reference</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;product&quot;</span><span class="p" data-group-id="257">]</span><span class="p" data-group-id="258">}</span><span class="p" data-group-id="259">]</span><span class="p" data-group-id="260">}</span><span class="p" data-group-id="261">}</span><span class="p">,</span><span class="w">
 </span><span class="p" data-group-id="317">{</span><span class="s2">&quot;product&quot;</span><span class="p">,</span><span class="w">
  </span><span class="p" data-group-id="316">{</span><span class="ss">:sequence</span><span class="p">,</span><span class="w">
   </span><span class="p" data-group-id="315">[</span><span class="ss">reference</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;value&quot;</span><span class="p">,</span><span class="w">
    </span><span class="ss">zero_or_more</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="314">{</span><span class="ss">:sequence</span><span class="p">,</span><span class="w">
     </span><span class="p" data-group-id="313">[</span><span class="ss">ordered_choice</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="310">[</span><span class="ss">literal</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;*&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">literal</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;/&quot;</span><span class="p" data-group-id="310">]</span><span class="p">,</span><span class="w"> </span><span class="ss">reference</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;value&quot;</span><span class="p" data-group-id="313">]</span><span class="p" data-group-id="314">}</span><span class="p" data-group-id="315">]</span><span class="p" data-group-id="316">}</span><span class="p" data-group-id="317">}</span><span class="p">,</span><span class="w">
 </span><span class="p" data-group-id="355">{</span><span class="s2">&quot;value&quot;</span><span class="p">,</span><span class="w">
  </span><span class="p" data-group-id="354">{</span><span class="ss">:ordered_choice</span><span class="p">,</span><span class="w">
   </span><span class="p" data-group-id="353">[</span><span class="ss">regex</span><span class="p">:</span><span class="w"> </span><span class="sr">~r/^</span><span class="se">\d</span><span class="sr">+/</span><span class="p">,</span><span class="w">
    </span><span class="ss">sequence</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="352">[</span><span class="ss">literal</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;(&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">reference</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;expr&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">literal</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;)&quot;</span><span class="p" data-group-id="352">]</span><span class="p" data-group-id="353">]</span><span class="p" data-group-id="354">}</span><span class="p" data-group-id="355">}</span><span class="p" data-group-id="356">]</span></code></pre>
<p>It looks like everything is working properly.</p>
<p>Now we have parser that can parse the grammar rules into a better representation.
But this is all still a little useless.
We can’t still do anything with this information.
When we wrote the arithmetic calculator, we’ve built an evaluator for arithmetic expressions.
That was an interpreter.
It interpreted the parsing structure at runtime to perform some actions.
We could build an interpreter for PEG Grammars too, but now that we’ve written an interpreter, let’s do something else.
Let’s write a compiler.</p>
<p>A compiler is a computer program that consumes a source representation and outputs a different source representation.
The Elixir compiler, for example, consumes Elixir code and outputs Erlang code.
The Erlang code is then <em>interpreted</em> by the BEAM.
The C compiler, on the other hand, consumes C code and outputs machine instructions (or some other intermediate representation that is converted into machine instructions).</p>
<p>We will write a compiler that compiles the PEG Grammer to ExSpirit rules.
The output will be a number of ExSpirit rules (defined using <code class="inline">defrule</code>), which we can embed in a module.
This will be more efficient than an interpreter, because we can take advantage of all the optimizations that ExSpirit can perform at compile time that will make our parsers faster.
Actually, ExSpirit itself will be doing most of the hard work.</p>
<pre><code class="nohighlight makeup elixir"><span class="kd">defmodule</span><span class="w"> </span><span class="nc">ExSpiritTutorial.PegParsers.PegGrammarCompiler</span><span class="w"> </span><span class="k" data-group-id="447">do</span><span class="w">

  </span><span class="kd">defmodule</span><span class="w"> </span><span class="nc">M</span><span class="w"> </span><span class="k" data-group-id="81">do</span><span class="w">
    </span><span class="na">@moduledoc</span><span class="w"> </span><span class="no">false</span><span class="w">
    </span><span class="kn">use</span><span class="w"> </span><span class="nc">ExSpirit.Parser</span><span class="p">,</span><span class="w"> </span><span class="ss">text</span><span class="p">:</span><span class="w"> </span><span class="no">true</span><span class="w">
  </span><span class="k" data-group-id="81">end</span><span class="w">

  </span><span class="kd">def</span><span class="w"> </span><span class="nf">compile_expression</span><span class="p" data-group-id="127">(</span><span class="p" data-group-id="126">{</span><span class="ss">:reference</span><span class="p">,</span><span class="w"> </span><span class="n">reference</span><span class="p" data-group-id="126">}</span><span class="p" data-group-id="127">)</span><span class="w"> </span><span class="k" data-group-id="193">do</span><span class="w">
    </span><span class="k">quote</span><span class="w"> </span><span class="k" data-group-id="192">do</span><span class="w">
      </span><span class="k">unquote</span><span class="p" data-group-id="187">(</span><span class="nc">String</span><span class="o">.</span><span class="n">to_atom</span><span class="p" data-group-id="186">(</span><span class="n">reference</span><span class="p" data-group-id="186">)</span><span class="p" data-group-id="187">)</span><span class="p" data-group-id="191">()</span><span class="w">
    </span><span class="k" data-group-id="192">end</span><span class="w">
  </span><span class="k" data-group-id="193">end</span><span class="w">

  </span><span class="kd">def</span><span class="w"> </span><span class="nf">compile_expression</span><span class="p" data-group-id="238">(</span><span class="p" data-group-id="237">{</span><span class="ss">:sequence</span><span class="p">,</span><span class="w"> </span><span class="n">sequence</span><span class="p" data-group-id="237">}</span><span class="p" data-group-id="238">)</span><span class="w"> </span><span class="k" data-group-id="305">do</span><span class="w">
    </span><span class="n">children</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Enum</span><span class="o">.</span><span class="n">map</span><span class="p" data-group-id="287">(</span><span class="n">sequence</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">compile_expression</span><span class="o">/</span><span class="mi">1</span><span class="p" data-group-id="287">)</span><span class="w">
    </span><span class="k">quote</span><span class="w"> </span><span class="k" data-group-id="304">do</span><span class="w">
      </span><span class="nc">M</span><span class="o">.</span><span class="n">seq</span><span class="p" data-group-id="301">(</span><span class="k">unquote</span><span class="p" data-group-id="300">(</span><span class="n">children</span><span class="p" data-group-id="300">)</span><span class="p" data-group-id="301">)</span><span class="w">
    </span><span class="k" data-group-id="304">end</span><span class="w">
  </span><span class="k" data-group-id="305">end</span><span class="w">

  </span><span class="kd">def</span><span class="w"> </span><span class="nf">compile_expression</span><span class="p" data-group-id="312">(</span><span class="p" data-group-id="311">{</span><span class="ss">:ordered_choice</span><span class="p">,</span><span class="w"> </span><span class="n">choices</span><span class="p" data-group-id="311">}</span><span class="p" data-group-id="312">)</span><span class="w"> </span><span class="k" data-group-id="348">do</span><span class="w">
    </span><span class="n">children</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Enum</span><span class="o">.</span><span class="n">map</span><span class="p" data-group-id="329">(</span><span class="n">choices</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">compile_expression</span><span class="o">/</span><span class="mi">1</span><span class="p" data-group-id="329">)</span><span class="w">
    </span><span class="k">quote</span><span class="w"> </span><span class="k" data-group-id="347">do</span><span class="w">
      </span><span class="nc">M</span><span class="o">.</span><span class="n">alt</span><span class="p" data-group-id="346">(</span><span class="k">unquote</span><span class="p" data-group-id="345">(</span><span class="n">children</span><span class="p" data-group-id="345">)</span><span class="p" data-group-id="346">)</span><span class="w">
    </span><span class="k" data-group-id="347">end</span><span class="w">
  </span><span class="k" data-group-id="348">end</span><span class="w">

  </span><span class="kd">def</span><span class="w"> </span><span class="nf">compile_expression</span><span class="p" data-group-id="360">(</span><span class="p" data-group-id="359">{</span><span class="ss">:zero_or_more</span><span class="p">,</span><span class="w"> </span><span class="n">parser</span><span class="p" data-group-id="359">}</span><span class="p" data-group-id="360">)</span><span class="w"> </span><span class="k" data-group-id="375">do</span><span class="w">
    </span><span class="k">quote</span><span class="w"> </span><span class="k" data-group-id="373">do</span><span class="w">
      </span><span class="nc">M</span><span class="o">.</span><span class="n">repeat</span><span class="p" data-group-id="372">(</span><span class="k">unquote</span><span class="p" data-group-id="371">(</span><span class="n">parser</span><span class="p" data-group-id="371">)</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p" data-group-id="372">)</span><span class="w">
    </span><span class="k" data-group-id="373">end</span><span class="w">
  </span><span class="k" data-group-id="375">end</span><span class="w">

  </span><span class="kd">def</span><span class="w"> </span><span class="nf">compile_expression</span><span class="p" data-group-id="382">(</span><span class="p" data-group-id="381">{</span><span class="ss">:one_or_more</span><span class="p">,</span><span class="w"> </span><span class="n">parser</span><span class="p" data-group-id="381">}</span><span class="p" data-group-id="382">)</span><span class="w"> </span><span class="k" data-group-id="400">do</span><span class="w">
    </span><span class="k">quote</span><span class="w"> </span><span class="k" data-group-id="399">do</span><span class="w">
      </span><span class="nc">M</span><span class="o">.</span><span class="n">repeat</span><span class="p" data-group-id="398">(</span><span class="k">unquote</span><span class="p" data-group-id="395">(</span><span class="n">parser</span><span class="p" data-group-id="395">)</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p" data-group-id="398">)</span><span class="w">
    </span><span class="k" data-group-id="399">end</span><span class="w">
  </span><span class="k" data-group-id="400">end</span><span class="w">

  </span><span class="kd">def</span><span class="w"> </span><span class="nf">compile_expression</span><span class="p" data-group-id="407">(</span><span class="p" data-group-id="406">{</span><span class="ss">:optional</span><span class="p">,</span><span class="w"> </span><span class="n">parser</span><span class="p" data-group-id="406">}</span><span class="p" data-group-id="407">)</span><span class="w"> </span><span class="k" data-group-id="434">do</span><span class="w">
    </span><span class="k">quote</span><span class="w"> </span><span class="k" data-group-id="433">do</span><span class="w">
      </span><span class="nc">M</span><span class="o">.</span><span class="n">alt</span><span class="p" data-group-id="432">(</span><span class="p" data-group-id="431">[</span><span class="w">
        </span><span class="k">unquote</span><span class="p" data-group-id="421">(</span><span class="n">parser</span><span class="p" data-group-id="421">)</span><span class="p">,</span><span class="w">
        </span><span class="nc">M</span><span class="o">.</span><span class="n">success</span><span class="p" data-group-id="430">(</span><span class="no">nil</span><span class="p" data-group-id="430">)</span><span class="w">
      </span><span class="p" data-group-id="431">]</span><span class="p" data-group-id="432">)</span><span class="w">
    </span><span class="k" data-group-id="433">end</span><span class="w">
  </span><span class="k" data-group-id="434">end</span><span class="w">

  </span><span class="kd">def</span><span class="w"> </span><span class="nf">compile_expression</span><span class="p" data-group-id="438">(</span><span class="p" data-group-id="437">{</span><span class="ss">:literal</span><span class="p">,</span><span class="w"> </span><span class="n">literal</span><span class="p" data-group-id="437">}</span><span class="p" data-group-id="438">)</span><span class="w"> </span><span class="k" data-group-id="446">do</span><span class="w">
    </span><span class="k">quote</span><span class="w"> </span><span class="k" data-group-id="445">do</span><span class="w">
      </span><span class="nc">M</span><span class="o">.</span><span class="n">lit</span><span class="p" data-group-id="444">(</span><span class="k">unquote</span><span class="p" data-group-id="443">(</span><span class="n">literal</span><span class="p" data-group-id="443">)</span><span class="p" data-group-id="444">)</span><span class="w">
    </span><span class="k" data-group-id="445">end</span><span class="w">
  </span><span class="k" data-group-id="446">end</span><span class="w">

</span><span class="k" data-group-id="447">end</span><span class="w">

</span><span class="kd">defmodule</span><span class="w"> </span><span class="nc">Lambda</span><span class="w"> </span><span class="k" data-group-id="472">do</span><span class="w">
  </span><span class="kd">defmacro</span><span class="w"> </span><span class="err">λ</span><span class="p" data-group-id="460">(</span><span class="n">ast</span><span class="p" data-group-id="460">)</span><span class="w"> </span><span class="k" data-group-id="471">do</span><span class="w">
    </span><span class="k">quote</span><span class="w"> </span><span class="k" data-group-id="469">do</span><span class="w">
      </span><span class="o">&amp;</span><span class="p" data-group-id="468">(</span><span class="k">unquote</span><span class="p" data-group-id="467">(</span><span class="n">ast</span><span class="p" data-group-id="467">)</span><span class="p" data-group-id="468">)</span><span class="w">
    </span><span class="k" data-group-id="469">end</span><span class="w">
  </span><span class="k" data-group-id="471">end</span><span class="w">
</span><span class="k" data-group-id="472">end</span><span class="w">

</span><span class="kd">defmodule</span><span class="w"> </span><span class="nc">GreekStatistics</span><span class="w"> </span><span class="k" data-group-id="521">do</span><span class="w">
  </span><span class="kd">def</span><span class="w"> </span><span class="err">σ</span><span class="p" data-group-id="480">(</span><span class="n">xs</span><span class="p" data-group-id="480">)</span><span class="w"> </span><span class="k" data-group-id="508">do</span><span class="w">
    </span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">length</span><span class="p" data-group-id="486">(</span><span class="n">xs</span><span class="p" data-group-id="486">)</span><span class="w">
    </span><span class="err">μ</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">μ</span><span class="p" data-group-id="488">(</span><span class="n">xs</span><span class="p" data-group-id="488">)</span><span class="w">
    </span><span class="nc">Enum</span><span class="o">.</span><span class="n">sum</span><span class="p" data-group-id="505">(</span><span class="k">for</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">xs</span><span class="p">,</span><span class="w"> </span><span class="ss">do</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="499">(</span><span class="n">x</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="err">μ</span><span class="p" data-group-id="499">)</span><span class="o">*</span><span class="p" data-group-id="504">(</span><span class="n">x</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="err">μ</span><span class="p" data-group-id="504">)</span><span class="p" data-group-id="505">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p" data-group-id="507">(</span><span class="n">n</span><span class="o">*</span><span class="n">n</span><span class="p" data-group-id="507">)</span><span class="w">
  </span><span class="k" data-group-id="508">end</span><span class="w">

  </span><span class="kd">def</span><span class="w"> </span><span class="err">μ</span><span class="p" data-group-id="511">(</span><span class="n">xs</span><span class="p" data-group-id="511">)</span><span class="w"> </span><span class="k" data-group-id="520">do</span><span class="w">
    </span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">length</span><span class="p" data-group-id="517">(</span><span class="n">xs</span><span class="p" data-group-id="517">)</span><span class="w">
    </span><span class="nc">Enum</span><span class="o">.</span><span class="n">sum</span><span class="p" data-group-id="518">(</span><span class="n">xs</span><span class="p" data-group-id="518">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">n</span><span class="w">
  </span><span class="k" data-group-id="520">end</span><span class="w">
</span><span class="k" data-group-id="521">end</span></code></pre>

      <footer class="footer">
        <p>
          <span class="line">
            Built using
            <a href="https://github.com/elixir-lang/ex_doc" title="ExDoc" rel="help" target="_blank">ExDoc</a> (v0.18.1),
          </span>
          <span class="line">
            designed by
            <a href="https://twitter.com/dignifiedquire" target="_blank" title="@dignifiedquire">Friedel Ziegelmayer</a>.
            </span>
        </p>
        <button class="night-mode-toggle"><span class="sr-only">Switch theme</span></button>
      </footer>
    </div>
  </div>
</section>
</div>
  <script src="dist/app-778c9ef903.js"></script>
  
  <script src="dist/ex_doc_makeup-js.js"></script>
  
  
  </body>
</html>

